<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>rails_kwargs_testing で緩やかに Rails 5 向けのテストコードに移行する</title>
  <link href="https://r7kamura.com/articles/2018-04-21-rails-kwargs-testing-rails-5-9056e5284965" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="rails_kwargs_testing という gem の紹介記事です。">
  <meta property="og:description" content="rails_kwargs_testing という gem の紹介記事です。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="rails_kwargs_testing で緩やかに Rails 5 向けのテストコードに移行する">
  <meta property="og:url" content="https://r7kamura.com/articles/2018-04-21-rails-kwargs-testing-rails-5-9056e5284965">
  
  <meta property="og:image" content="https://r7kamura.com/default_og_image.jpg">
  <meta property="twitter:card" content="summary">
  
</head>
<body>
  <header>
    <nav>
      <p>
        <a href="/">r7kamura.com</a>
      </p>
      <ul>
        <li>
          <a href="/links">リンク集</a>
        </li>
        <li>
          <a href="https://www.google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2018-04-21T00:00:00+00:00">2018年04月21日</time>
    <h1>rails_kwargs_testing で緩やかに Rails 5 向けのテストコードに移行する</h1>
  </header>
  <div>
    <p>rails_kwargs_testing という gem の紹介記事です。</p>

<p><a href="https://github.com/r7kamura/rails_kwargs_testing">https://github.com/r7kamura/rails_kwargs_testing</a></p>

<h2>Rails 4 から 5 でテストで使う HTTP メソッドの引数が変わった</h2>

<p>Rails 4 から 5 にかけて、ActionController::TestCase と ActionDispatch::IntegrationTest の #get や #post などのメソッドの引数の形式が変わり、Rails 5 ではキーワード引数を利用するようになりました。RSpec であれば、ActionController::TestCase は controller-specs、ActionDispatch::IntegrationTest は request-specs で利用するやつです。</p>

<p><a href="https://github.com/rails/rails/pull/18323">https://github.com/rails/rails/pull/18323</a></p>

<h2>Rails 4 でも rails_kwargs_testing でキーワード引数を使う</h2>

<p>Rails 4 から 5 への変更と共に、全ての引数の形式を書き換える変更を同時に入れることも可能です。しかし、Rails 4 から 5 への移行は比較的長い時間をかけて行われることが多く、他のブランチでテストが追加あるいは変更される中でこの手の変更を加えると、merge 時に問題が起きたり、conflict が発生したりする可能性が高まってしまいます。また、レビューの難しさや問題発生時の対処のことなども考えると、可能であれば Rails 4 と 5 で両方動く変更は先に加えておき、バージョン変更時の差分はできるだけ小さくしておきたいものです。</p>

<p>こういった背景から、Rails 4 の状態で引数の形式だけを変更しておきたいという需要があり、rails_kwargs_testing という gem をつくりました。実際には、業務委託で色々なサービスの Rails のバージョンを上げる仕事を請け負っている中で、これまで使ってきたコードをライブラリとしてまとめたような形になってます。</p>

<p><a href="https://github.com/r7kamura/rails_kwargs_testing">https://github.com/r7kamura/rails_kwargs_testing</a></p>

<h2>使い方</h2>

<p>README を読めば分かるようになっていますが、補足も含めて少し説明しておきます。rspec-rails を一般的な形で使っているとして、まずは Gemfile の :test group に rails_kwargs_testing を追加したあと、spec/rails_helper.rb で rails_kwargs_testing から提供されている module を prepend します。</p>

<pre><code class="ruby">RSpec.configure do |config|
  config.prepend RailsKwargsTesting::ControllerMethods, type: :controller
  config.prepend RailsKwargsTesting::RequestMethods, type: :request
end
</code></pre>

<p>controller-specs には RailsKwargsTesting::ControllerMethods を、request-specs には RailsKwargsTesting::RequestMethods を prepend しています。これで #get や #post などのメソッドがキーワード引数だけを取るように上書きされます。</p>

<p>次にメソッドの引数を全てキーワード引数形式に変更し、全てのテストが成功することを確認すれば完了です。変更しなければ ArgumentError が発生します。<del>コードの変更には rails5-spec-converter を利用するのが良いと思います。コンマの扱いなどに少し不具合はありますが、それを差し置いても非常に便利なツールです。</del>今となっては、rubocop-railsのRails/HttpPositionalArguments copを利用してauto-correctするのが良いと思います。</p>

<p>全てのテストが成功することを確認したら、主流の開発用ブランチへ変更を merge し、Rails 5 への残りの移行作業をがんばって進めましょう。</p>

  </div>
</article>

  </main>
</body>
</html>
