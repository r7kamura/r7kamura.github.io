<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>RailsでBower</title>
  <link href="https://r7kamura.com/articles/2014-11-27-q" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="RailsでBowerを利用して開発する方法と、Herokuで動作させる方法について説明する。">
  <meta property="og:description" content="RailsでBowerを利用して開発する方法と、Herokuで動作させる方法について説明する。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="RailsでBower">
  <meta property="og:url" content="https://r7kamura.com/articles/2014-11-27-q">
  
  <meta property="og:image" content="https://r7kamura.com/default_og_image.jpg">
  <meta property="twitter:card" content="summary">
  
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura.com</a>
      <ul>
        <li>
          <a href="/links">リンク集</a>
        </li>
        <li>
          <a href="https://www.google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2014-11-27T00:00:00+00:00">2014年11月27日</time>
    <h1>RailsでBower</h1>
  </header>
  <div>
    <p>RailsでBowerを利用して開発する方法と、Herokuで動作させる方法について説明する。</p>

<h2>brew install npm</h2>

<p>bowerを利用するにはnpmが必要になる。開発環境にMacを利用している場合、npmはhomebrewでインストールできる。余談だけど、普通にbrew installで開発者が各自手元にインストールすると「開発環境ではこういうツールを利用している」という情報が失われて困るだろうから、(今となってはもう非推奨になったが) Brewfileに記述するとか、Makefileやscript以下にそのプロジェクト用の環境構築のためのスクリプトを用意しておいた方が良い。</p>

<pre><code>brew install npm
</code></pre>

<h2>npm init</h2>

<p>そのプロジェクトで初めてnpmを利用する場合、npm initを実行すると、package.jsonというファイルのひな形を生成してくれる。デフォルトで生成される奴は冗長な部分が多いので、適切に編集したほうが良いかもしれない。npm・nodeのversionは開発環境と本番環境とで揃えておいた方が吉。heroku-buildpack-nodejsを利用するなら、package.jsonは必須。</p>

<pre><code>npm init
echo "/node_modules" &gt;&gt; .gitignore
</code></pre>

<pre><code>{
  "engines": {
    "node": "0.10.31",
    "npm": "2.0.0-beta.0"
  },
  "private": true
}
</code></pre>

<h2>npm install bower</h2>

<p>npm install bowerを実行すると、./node_modulesディレクトリにbowerがインストールされる。このとき--saveオプションを付けておくと、package.jsonのdependenciesプロパティ内にbowerに関する情報を追記してくれる。</p>

<pre><code>npm install bower --save
</code></pre>

<h2>bower init</h2>

<p>npm init同様、bower initを実行するとbower.jsonのひな形を生成してくれる。</p>

<pre><code>./node_modules/bower/bin/bower init
echo "/bower_components" &gt;&gt; .gitignore
</code></pre>

<h2>bower install</h2>

<p>例えばtwitter bootstrapのsass版を利用したい場合、bower install bootstrap-sass-officialとやると、./bower_componentsディレクトリにbootstrap-sass-officialがインストールされる。npm install同様、--saveオプションを付けておくとbower.jsonが編集される。</p>

<pre><code>./node_modules/bower/bin/bower install bootstrap-sass-official --save
</code></pre>

<h2>config.assets.paths</h2>

<p>Sprocketsでコンパイルするjavascriptやstylesheetではrequireディレクティブが利用できるが、このとき指定するパスはconfig.assets.pathに登録したディレクトリからの相対パスになる。bowerを利用する場合は、bower_componentsを登録しておく。</p>

<pre><code class="rb"># config/application.rb
module MyApp
  class Application &lt; Rails::Application
    config.assets.paths &lt;&lt; config.root.join('bower_components')
  end
end
</code></pre>

<h2>assets</h2>

<p>JavaScriptから利用する場合は次のような感じになる。ファイルパスは各bowerパッケージごとにそれぞれ異なるので、./bower_componentsディレクトリの中を見たりして逐次確認する。</p>

<pre><code class="js">// app/assets/javascripts/application.js
//
//= require bootstrap-sass-official/assets/javascripts/bootstrap/transition
//= require bootstrap-sass-official/assets/javascripts/bootstrap/tooltip
//= require bootstrap-sass-official/assets/javascripts/bootstrap/popover
</code></pre>

<p>Sassから利用する場合は、直接CSSを利用するならrequireを書くだけで済むが、変数やmixinを利用したい場合は<code>@import</code>を利用することもできる。この場合もパスの指定方法はrequireと同様になる。</p>

<pre><code class="scss">@import "bootstrap-sass-official/assets/stylesheets/bootstrap/variables";
</code></pre>

<h2>heroku-buildpack-multi</h2>

<p>Herokuで動かす場合には、nodeとrubyの両方が動作する環境が必要になる。Herokuはデプロイしたコードからアプリケーションの種類を判別し、自動的に利用するBuildpackを選択する。環境変数BUILDPACK_URLを設定すると、利用するBuildpackを変更できる。複数のBuildpackを併用したい場合、heroku-buildpack-multiを利用すると実現できる。.buildpacksに改行区切りでbuildpackのURLを記述しておくと、heroku-buildpack-multiはそれらを利用してくれるようになる。</p>

<pre><code class="sh">heroku config:set BUILDPACK_URL=https://github.com/heroku/heroku-buildpack-multi.git
echo https://github.com/heroku/heroku-buildpack-nodejs.git &gt;&gt; .buildpacks
echo https://github.com/heroku/heroku-buildpack-ruby.git   &gt;&gt; .buildpacks
</code></pre>

<h2>heroku-buildpack-nodejs</h2>

<p>利用するnodeとnpmのversionを指定し、bowerを利用できるようにする。heroku-buildpack-nodejsはpackage.jsonを見て適切なものを利用してくれる。</p>

<h2>lib/tasks/bower.rake</h2>

<p>rake assets:precompileの実行前にbower install --productionが実行されるようにする。このコードは<a href="https://github.com/42dev/bower-rails/blob/master/lib/tasks/bower.rake">42dev/bower-rails</a>を参考にした。</p>

<pre><code class="rb"># lib/tasks/bower.rake
namespace :bower do
  desc "Run `bower install --production` after assets:precompile"
  task :install do
    sh "./node_modules/bower/bin/bower install --production"
  end
end

task "assets:precompile" =&gt; ["bower:install"]
</code></pre>

<h2>rake assets:precompile</h2>

<p>手元で確認する場合は、rake assets:precompileを直接実行し、public/assets以下に生成された<em>.cssや</em>.jsを確認し、bower由来のコードが意図通り含まれているか確認すると良い。</p>

<pre><code>bundle exec rake assets:precompile
</code></pre>

  </div>
</article>

  </main>
</body>
</html>
