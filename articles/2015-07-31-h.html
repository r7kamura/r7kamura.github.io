<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>Node.jsでAWSのAPIで認証するやつ書いた</title>
  <link href="https://r7kamura.com/articles/2015-07-31-h" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="https://github.com/r7kamura/aws-signer-v4">
  <meta property="og:description" content="https://github.com/r7kamura/aws-signer-v4">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Node.jsでAWSのAPIで認証するやつ書いた">
  <meta property="og:url" content="https://r7kamura.com/articles/2015-07-31-h">
  
  <meta property="og:image" content="https://r7kamura.com/default_og_image.jpg">
  <meta property="twitter:card" content="summary">
  
</head>
<body>
  <header>
    <nav>
      <p>
        <a href="/">r7kamura.com</a>
      </p>
      <ul>
        <li>
          <a href="/links">リンク集</a>
        </li>
        <li>
          <a href="https://www.google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2015-07-31T00:00:00+00:00">2015年07月31日</time>
    <h1>Node.jsでAWSのAPIで認証するやつ書いた</h1>
  </header>
  <div>
    <p><a href="https://github.com/r7kamura/aws-signer-v4">https://github.com/r7kamura/aws-signer-v4</a></p>

<p>Amazon API GatewayのREST APIを利用したかったんだけど、Node.js用のaws-sdkにはまだその機能が入っていないこともあり、自分で認証するためのライブラリを書いた。リクエストのメソッド、URL、ヘッダ、ボディ、AWSのAccessKeyID、SecretAccessKey、リージョンを、決められた手順に従って加工し、Authorizationリクエストヘッダに入れることで認証が通るようになる。その決められた手順を実装した。詳しい仕様は <a href="http://docs.aws.amazon.com/ja_jp/AmazonS3/latest/API/sig-v4-authenticating-requests.html">AWS Signature version 4</a> のページに記載されているがほとんどの人間は読む必要は無い。自分でこのロジックを実装したいなら、JavaScriptの場合は <a href="https://github.com/aws/aws-sdk-js/blob/e0fcbe08bae68fdd86ce6a5bf50c726982553277/lib/signers/v4.js">aws-sdk-js/lib//signers/v4.js</a> にAWSのSDKを利用しながら実装されたコードが載っているので参考になる。Rubyの場合は <a href="https://github.com/aws/aws-sdk-ruby/blob/master/aws-sdk-core/lib/aws-sdk-core/signers/v4.rb">aws-sdk-core/lib/aws-sdk-core/signers/v4.rb</a>や、3rdパーティの実装である <a href="https://github.com/cmdrkeene/aws4">aws4</a> を読むのが分かりやすい。</p>

<p>つくったライブラリはこういう感じで使えるようになってる。</p>

<pre><code>var Sign = require('aws-signer-v4'); request.headers.Authorization = new Sign( accessKeyId: 'AWS\_ACCESS\_KEY\_ID', body: request.body, headers: request.headers, method: 'GET', region: 'ua-east-1', secretAccessKey: 'AWS\_SECRET\_ACCESS\_KEY', url: request.url ).toString()
</code></pre>

<p>昨日、自分で好きなmiddlewareを組み合わせて君だけの最強のHTTPクライアントをつくれる <a href="https://github.com/r7kamura/stackable-fetcher">stackable-fetcher</a> というやつを書いたので、今回つくった aws-signer-v4 を組み合わせて、リクエストを送る前に勝手に認証用のAuthorizationヘッダを組み立ててくれるmiddlewareを書いてみた。<a href="https://github.com/r7kamura/stackable-fetcher/blob/master/examples/middlewares/aws-signer-v4.js">stackable-fetcherのexamples</a> に置いてある。こういう感じでuseして使える。</p>

<pre><code>var AwsSignerV4 = require('/path/to/middlewares/aws-signer-v4'); var Fetcher = require('stackable-fetcher'); var fetcher = new Fetcher() .use(AwsSignerV4, { accessKeyId: '...', secretAccessKey: '...', region: '...' }) fetcher.get('https://apigateway.us-east-1.amazonaws.com/restapis') .then(function (response) { console.log(response.status); });
</code></pre>

<p>Node.js、Rubyとかと比べると場が整っていない感じだけど (場とは?)、うまく書けば少しのコードで恩恵を受けられる人が多くて良いと思う。</p>

  </div>
</article>

  </main>
</body>
</html>
