<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>LambdaとAPI Gatewayまとめて管理するやつ</title>
  <link href="https://r7kamura.com/articles/2015-08-06-h" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="LambdaとAPI Gatewayの自動化ツールの開発がそれぞれ進んできたので、そろそろまとめて管理するための1つのツールをつくろうとしてる。">
  <meta property="og:description" content="LambdaとAPI Gatewayの自動化ツールの開発がそれぞれ進んできたので、そろそろまとめて管理するための1つのツールをつくろうとしてる。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="LambdaとAPI Gatewayまとめて管理するやつ">
  <meta property="og:url" content="https://r7kamura.com/articles/2015-08-06-h">
  
  <meta property="og:image" content="https://r7kamura.com/default_og_image.jpg">
  <meta property="twitter:card" content="summary">
  
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura.com</a>
      <ul>
        <li>
          <a href="/articles">一覧</a>
        </li>
        <li>
          <a href="https://www.google.com/?as_sitesearch=r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <h1>LambdaとAPI Gatewayまとめて管理するやつ</h1>
  <footer>
    <p>
      <time datetime="2015-08-06T00:00:00+00:00">2015年08月06日</time>
    </p>
  </footer>
  <div>
    <p>LambdaとAPI Gatewayの自動化ツールの開発がそれぞれ進んできたので、そろそろまとめて管理するための1つのツールをつくろうとしてる。<a href="https://github.com/servant-app/JAWS">servant-app/JAWS</a> や <a href="https://github.com/awslabs/aws-apigateway-swagger-importer">awslabs/aws-apigateway-swagger-importer</a> などのツールはSwaggerというスキーマファイルに全てのエンドポイントのインターフェースをまとめて定義するという方法になっているけれど、元々1つのエンドポイントあたりの情報量が多いし、エンドポイントの数が増えるにつれてSwaggerのファイルの内容量がどんどん増えて編集しづらくなっていくことが容易に想像できる。</p>

<p>そこで、各エンドポイント (ここではHTTPメソッドとURLで特定できる <code>GET /recipes</code> みたいな単位のことをエンドポイントと呼んでいる) ごとにディレクトリを分け、それぞれのディレクトリ内に package.json, config.json, index.js を配置する、というルールにしようと考えている。Swaggerは最初は使ってみるけれど、最終的には使うのをやめるかも。勿論、内部で利用する表現形式からSwaggerを生成することは出来ると思うので、Swaggerの恩恵が受けられなくなるというわけではないが、ユーザに直接書いてもらうところでSwaggerを見せるのはやめとこうかなという感じ。以下がファイル構成の例。</p>

<pre class="code" data-lang="" data-unlink>.
|-- README.md
|-- actions
|   |-- show_top_page
|   |   |-- package.json
|   |   |-- config.json
|   |   `-- index.js
|   |-- list_articles
|   |   |-- package.json
|   |   |-- config.json
|   |   `-- index.js
|   `-- show_article
|       |-- package.json
|       |-- config.json
|       `-- index.js
|-- lib
`-- global-config.json
`-- package.json</pre>

<p>actionsというディレクトリの中に、show_top_page や list_articles、show_article といったディレクトリがある。actionという名前を付けたのはRails由来で、RailsではControllerクラスに定義されてリクエストを処理することになるメソッドのことをactionと呼ぶので、ここでもactionという名前を使うことにした。functionsでは汎用的ずぎてAPI Gatewayに関する情報も含まれているということが分かりづらいし、 かといってendpointsとかだとLambda感が薄れてしまうので難しい。<a href="https://github.com/servant-app/JAWS">servant-app/JAWS</a> ではうちでいうactionsの代わりにapiというディレクトリを使うことになっているみたい。actionの名前はディレクトリ名で表現するということにする。actionsディレクトリの中に全てのactionが置かれるということはactionの名前は一意になるので、特定のactionだけデプロイしたいとかそういうときに <code>deploy show_article</code> みたいな感じで指定できるようになりそう。</p>

<p>各action用のディレクトリにはconfig.jsonを配置するようになっているが、このファイルにはそのactionがAPI Gateway上でどういうエンドポイントとして提供されかという情報と、Lambda上でどう実行されるかという設定をそこに書いてもらうためにそれを置いた。index.js にはLambdaで実行されるべき関数を定義してもらう。package.jsonは、少し面倒だと思われるかもしれないがそれぞれのactionごとに別々で用意させるようにしてある。複数のactionで共通するロジックは、lib以下において適当にrequireしてもらおうと思っている。package.json に独自のメタデータを付け加えることは、文化はともかく仕様では一応許されているみたいなので、もしかしたら package.json に統一させるかもしれない。<a href="http://stackoverflow.com/questions/10065564/add-custom-metadata-or-config-to-package-json-is-it-valid">node.js - Add custom metadata or config to package.json, is it valid? - Stack Overflow</a></p>

<p>前に <a href="http://r7kamura.hatenablog.com/entry/2015/08/04/015315">Amazon Lambdaにまとめてアップロードするやつ - ✘╹◡╹✘</a> で実験したときのコードによって、複数のディレクトリでそれぞれ npm install させたりコンパイルしたりZIPにしてLambdaにデプロイしたりするというのは自動化できるようになってるんで、今度はactionの名前を指定して特定のactionだけデプロイするとか、ローカル環境でサーバを立ち上げて試せるようにするとか、その辺のツールをつくっていくつもり。</p>

  </div>
</article>

  </main>
</body>
</html>
