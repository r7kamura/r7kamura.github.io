<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>gitで怪しいファイルを追加すると警告する</title>
  <link href="https://r7kamura.com/articles/2011-11-26-h" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="前にCSSの整形を正規表現だけで何とかするというエントリを書いて、このままだと面倒で誰も使わないので、怪しいCSSを書くとgitで警告を表示するようにした。">
  <meta property="og:description" content="前にCSSの整形を正規表現だけで何とかするというエントリを書いて、このままだと面倒で誰も使わないので、怪しいCSSを書くとgitで警告を表示するようにした。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="gitで怪しいファイルを追加すると警告する">
  <meta property="og:url" content="https://r7kamura.com/articles/2011-11-26-h">
  
  <meta property="og:image" content="https://r7kamura.com/default_og_image.jpg">
  <meta property="twitter:card" content="summary">
  
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura.com</a>
      <ul>
        <li>
          <a href="/articles">一覧</a>
        </li>
        <li>
          <a href="https://www.google.com/?as_sitesearch=r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2011-11-26T00:00:00+00:00">2011年11月26日</time>
    <h1>gitで怪しいファイルを追加すると警告する</h1>
  </header>
  <div>
    <p>前に<a href="http://r7kamura.hatenablog.com/entry/2011/11/18/004957">CSSの整形を正規表現だけで何とかする</a>というエントリを書いて、このままだと面倒で誰も使わないので、怪しいCSSを書くとgitで警告を表示するようにした。警告を出すだけでファイルの中身は書き換わらない。</p>

<h4>使い方</h4>

<p>.gitattributesとgit-configに設定する。</p>

<pre><code>$ echo '\*.css filter=reviewcss' \&gt;\&gt; .gitattributes $ git config filter.reviewcss.clean './sample.rb %f'
</code></pre>

<pre><code>$ vim hell.css $ cat hell.css .entry-content a,.entry-content p{ color:black; background: url('http://tinyurl.com/8ye9tro')no-repeat; } $ git add hell.css \*\*\*\* WARNING!! \*\*\*\* hell.css:1 中括弧の前に空白がない hell.css:1 "."がインデントされている hell.css:2 末尾に空白がある hell.css:2 幅1〜3のインデントがある hell.css:2 コロンの後に空白がない hell.css:3 括弧の後に空白がない hell.css:4 "}"がインデントされている
</code></pre>

<h4>設計</h4>

<p>.gitattributesでreviewcssという名前のfilterを定義し、git-configでreviewcssのために利用するコマンドを指定する。%fを付けると、実行時に適用されるファイル名に展開されるので、引数として受け取ってスクリプト内でファイル名を参照する。</p>

<p>.gitattributesを利用するとcommitに含まれてしまうので、.git/info/attributesに記述しても良い。個人的にはgit-configの設定をcommitに含めるというのがしたいけど、どうすればいいのか分からない。.gitconfigをレポジトリルートに置いておけばそれを読んでくれる、みたいな機能がgitに欲しい。<a href="https://github.com/bbatsov/ruby-style-guide">Ruby Style Guide</a>とか、こういうコードスタイル的なものを正規表現で記述できると良さそう。</p>

<p>利用したsample.rbはこんな感じ。</p>

<pre><code>#!/usr/bin/env ruby str = STDIN.read filename = ARGV.first conditions = { /\t/ =\&gt; 'タブ文字がある', / +$/ =\&gt; '末尾に空白がある', / +,/ =\&gt; 'コロンの前に空白がある', /[^]\{/ =\&gt; '中括弧の前に空白がない', /\)\w/ =\&gt; '括弧の後に空白がない', /^ .\*:[^ ^D^\/]/ =\&gt; 'コロンの後に空白がない', /^ {1,3}[^]/ =\&gt; '幅1〜3のインデントがある', /^ {5,7}[^]/ =\&gt; '幅5〜7のインデントがある', /^ +\./ =\&gt; '"."がインデントされている', /^ +\}/ =\&gt; '"}"がインデントされている', /^ +#[^\d^A-F^a-f]/ =\&gt; '"#"がインデントされている' } warnings = '' str.lines.with\_index do |line, num| conditions.each do |regexp, msg| warnings \&lt;\&lt; "#{filename}:#{num + 1} #{msg}\n" if line.match regexp end end if warnings.size \&gt; 0 STDERR.puts '\*\*\*\* WARNING!! \*\*\*\*' STDERR.puts warnings end STDOUT.puts str
</code></pre>

  </div>
</article>

  </main>
</body>
</html>
