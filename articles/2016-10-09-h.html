<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>汎用絵文字ライブラリ Somemoji</title>
  <link href="https://r7kamura.com/articles/2016-10-09-h" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="ここ最近絵文字で遊んでいて、Somemoji というライブラリをつくったので知見を共有します。">
  <meta property="og:description" content="ここ最近絵文字で遊んでいて、Somemoji というライブラリをつくったので知見を共有します。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="汎用絵文字ライブラリ Somemoji">
  <meta property="og:url" content="https://r7kamura.com/articles/2016-10-09-h">
  
  <meta property="og:image" content="https://i.imgur.com/ELuRQu7.jpg">
  <meta property="twitter:card" content="summary_large_image">
  
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura.com</a>
      <ul>
        <li>
          <a href="/articles">一覧</a>
        </li>
        <li>
          <a href="https://www.google.com/?as_sitesearch=r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2016-10-09T00:00:00+00:00">2016年10月09日</time>
    <h1>汎用絵文字ライブラリ Somemoji</h1>
  </header>
  <div>
    <p><a href="https://i.imgur.com/ELuRQu7.jpg" target="_blank"><img src="https://i.imgur.com/ELuRQu7.jpg" alt="image"></a></p>

<p>ここ最近絵文字で遊んでいて、<a href="https://github.com/r7kamura/somemoji">Somemoji</a> というライブラリをつくったので知見を共有します。</p>

<h2>さまざまな絵文字セット</h2>

<p>様々なプラットフォームのために、様々な組織が、様々な絵文字セット (絵文字画像の集合) を提供しています。</p>

<ul>
<li>Apple</li>
<li>emojidex</li>
<li>EmojiOne</li>
<li>Facebook</li>
<li>Google</li>
<li>HTC</li>
<li>LG</li>
<li>Microsoft</li>
<li>Mozilla</li>
<li>Samsung</li>
<li>Twitter</li>
</ul>

<p>大抵の絵文字セットはUnicodeのEmojiの仕様に則って実装されていて、このコードポイントに対応する絵文字画像はこれ、というように互換性があります。Unicode 6.0, Unicode 7.0, Unicode 8.0, ... とバージョンが増えるに従って定義されるEmojiの数も増えていっているので、それぞれの絵文字セットごとに対応具合はまちまちという状況ではあるものの、よく使う主要なものについては大体カバーされています。</p>

<h2>オープンソースの絵文字セット</h2>

<p>最近は寛容なライセンスで提供される絵文字セットも増えてきていて、それぞれのライセンスに従って自分のサービスで絵文字画像を利用できるようになってきています。</p>

<ul>
<li><a href="https://github.com/Ranks/emojione">EmojiOne</a></li>
<li><a href="https://github.com/googlei18n/noto-emoji">Noto Emoji</a></li>
<li><a href="https://github.com/twitter/twemoji">Twemoji</a></li>
<li><a href="https://github.com/mozilla/fxemoji">Firefox OS Emojis</a></li>
</ul>

<h2>汎用絵文字ライブラリ</h2>

<p><a href="https://github.com/r7kamura/somemoji">https://github.com/r7kamura/somemoji</a></p>

<p>さまざまな絵文字セットがあり、それぞれの絵文字セットごとにさまざまなライブラリがあるものの、ライブラリで出来ることもまちまちで、サービスの都合で使う絵文字セットを切り替えたりしようと思うと簡単にはいきません。なので、ライブラリも含めた絵文字セットの選定の段階が非常に大事で、そこでミスると面倒で辛い状態になってしまいます。そこで、絵文字セットに関わらず利用できる汎用絵文字ライブラリ <a href="https://github.com/r7kamura/somemoji">Somemoji</a> を開発することにしました。</p>

<p>Somemojiには、以下のファイルが同梱されています。</p>

<ul>
<li>それぞれの絵文字の属性情報を定義したJSON</li>
<li>それぞれの絵文字セットで対応している絵文字を定義したJSON</li>
<li>絵文字画像を手元に持ってくるためのコマンドラインツール</li>
<li>Ruby用のライブラリ</li>
</ul>

<h2>使い方</h2>

<h3>絵文字画像を一括ダウンロードする</h3>

<p><code>somemoji</code> というコマンドラインツールが同梱されていて、これを利用して絵文字画像を手元にダウンロードしてくることができます。例えば、デプロイ前にAmazon S3に絵文字画像を配置するときに利用したりします。なお、絵文字セットによってはMaxCDNなどから配信されている絵文字画像が利用できたりするので、Webサービスで利用する場合は必ずしもダウンロードしてくる必要はありません。</p>

<pre><code>$ somemoji --help Usage: somemoji extract [options] -p, --provider (required) apple, emoji\_one, noto, or twemoji -d, --destination (required) directory path to locate extracted image files -f, --format png or svg (default: png) -s, --size Some providers have different size image files -h, --help Display this help message
</code></pre>

<p>Twemojiの画像データを <code>./images/emoji</code> 以下に持ってくるにはこう。</p>

<pre><code>somemoji extract --provider=twemoji --destination=./images/emoji
</code></pre>

<h3>文中に含まれる絵文字コードを画像に置換する</h3>

<p><code>"I :heart: Emoji"</code> の <code>heart</code> の部分の名前のことを絵文字コードと言ったりするんですが (主にSlackなどはそう呼称している)、文中に含まれる絵文字コードをHTMLのimg要素に置き換えてみるというコードの例がこれです。EmojiOneで利用可能な絵文字について、置換を試みています。</p>

<pre><code>Somemoji.emoji\_one\_emoji\_collection.replace\_code("I :heart: Emoji") do |emoji| %(\&lt;img alt="#{emoji.character}" class="emoji" src="/assets/emoji/#{emoji.base\_path}.png"\&gt;)end#=\&gt; 'I \&lt;img alt="❤" class="emoji" src="/assets/emoji/unicode/2764.png"\&gt; Emoji'
</code></pre>

<h3>文中に含まれる絵文字を画像に置換する</h3>

<p>文中に含まれる絵文字を、先述の例と同様にimg要素に置き換えてみるというコードの例がこれです。例えば、サービス上で表示する絵文字は全てTwitterの絵文字画像に統一したいなあ、みたいなときに使えます。</p>

<pre><code>Somemoji.twemoji\_emoji\_collection.replace\_character("I 💗 Emoji") do |emoji| %(\&lt;img alt="#{emoji.character}" class="emoji" src="/assets/emoji/#{emoji.base\_path}.png"\&gt;)end#=\&gt; 'I \&lt;img alt="💗" class="emoji" src="/assets/emoji/unicode/1f497.png"\&gt; Emoji'
</code></pre>

<h3>独自の絵文字を追加する</h3>

<p>サービスによっては、自社のアイコンなど独自の絵文字を追加したい場合もあると思います。そういう場合のために、ランタイムで絵文字を追加できるような機能を持っています。</p>

<pre><code>custom\_emoji\_collection = Somemoji.emoji\_one\_emoji\_collection + Somemoji::EmojiCollection.new( [Somemoji::Emoji.new(code: "foo"), Somemoji::Emoji.new(code: "bar"),] ) custom\_emoji\_collection.find\_by\_code("foo").class #=\&gt; Somemoji::Emojicustom\_emoji\_collection.find\_by\_code("bar").class #=\&gt; Somemoji::Emojicustom\_emoji\_collection.find\_by\_code("100").class #=\&gt; Somemoji::Emojicustom\_emoji\_collection.replace\_code("I :bar: Emoji") do |emoji| %(\&lt;img alt="#{emoji.character || emoji.code}" class="emoji" src="/images/emoji/#{emoji.base\_path}.png"\&gt;)end #=\&gt; 'I \&lt;img alt="bar" class="emoji" src="/images/emoji/bar.png"\&gt; Emoji'
</code></pre>

<h3>Markdown内の絵文字を置換する</h3>

<p>RubyでMarkdownの変換処理を構造的にやる場合、恐らく <a href="https://github.com/jch/html-pipeline">HTML::Pipeline</a> を使うことになると思います。絵文字コードを置換するようなHTML::Pipelineのフィルターを書くのも、以下のように実現できます。HTML::Pipelineについては <a href="/articles/2014-10-16-q">Markdownを拡張して独自記法をつくる</a> という記事を前に書いたので良ければご覧ください。</p>

<pre><code>class EmojiFilter \&lt; ::HTML::Pipeline::FilterIGNORED\_ANCESTOR\_ELEMENT\_NAMES = %w( code pre tt)# @note Implementation for HTML::Pipeline::Filterdef call doc.search(".//text()").each do |node| unless has\_ancestor?(node, IGNORED\_ANCESTOR\_ELEMENT\_NAMES) node.replace( ::Somemoji.twemoji\_emoji\_collection.replace\_code(node.to\_html) do |emoji| %W( \&lt;img alt="#{emoji.code}" class="emoji" height="20" src="/images/emoji/#{emoji.base\_path}.png" title=":#{emoji.code}:" width="20"\&gt;).join(" ") end ) endend doc endend
</code></pre>

<h2>おわり</h2>

<p><a href="https://github.com/r7kamura/somemoji">Somemoji</a> 開発の背景や使い方を説明しました。今後の展開として、JavaScript環境で使えるようにする対応と、絵文字画像ダウンロードの高速化、サポートする絵文字セットの増加、絵文字セットごとの利用できる文字種とライセンスの明示、絵文字定義ファイルの追加を考えています。</p>

<h2>追記</h2>

<blockquote>
<p>Somemojiつかって掲示板に絵文字切り替え機能つけてみた <a href="https://t.co/T9RPI9zlVI">pic.twitter.com/T9RPI9zlVI</a></p>

<p>— 完全週休七日制 (@r7kamura) <a href="https://twitter.com/r7kamura/status/785078578174042112">2016年10月9日</a></p>
</blockquote>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

  </div>
</article>

  </main>
</body>
</html>
