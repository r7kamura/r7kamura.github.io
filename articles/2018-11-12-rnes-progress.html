<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>NESエミュレータのここまでの進捗</title>
  <link href="https://r7kamura.com/articles/2018-11-12-rnes-progress" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="r7kamura/rnes の進捗について。">
  <meta property="og:description" content="r7kamura/rnes の進捗について。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="NESエミュレータのここまでの進捗">
  <meta property="og:url" content="https://r7kamura.com/articles/2018-11-12-rnes-progress">
  
  <meta property="og:image" content="https://r7kamura.com/images/2018-11-12-rnes-progress-1.png">
  <meta property="twitter:card" content="summary_large_image">
  
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura.com</a>
      <ul>
        <li>
          <a href="/articles">一覧</a>
        </li>
        <li>
          <a href="https://www.google.com/?as_sitesearch=r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2018-11-12T00:00:00+09:00">2018年11月12日</time>
    <h1>NESエミュレータのここまでの進捗</h1>
  </header>
  <div>
    <p>r7kamura/rnes の進捗について。</p>

<h2>2018年11月2日</h2>

<p>RubyでNESエミュレータをつくりはじめたのが2018年11月2日の夜。ROM のパーサから書き始めて、CPU、CPU バス、PPU、PPU バス、ターミナルでの画面描画用のレンダラーの順で実装を進めていくことに。</p>

<h2>2018年11月3日</h2>

<p>つくりはじめてから16時間ぐらいコードを書いて、ようやく HELLO, WORLD! を表示できるように。実行速度が気になるので fps を測ってみたところ…… 3fps……そんな……。この HELLO, WORLD! は、<a href="http://hp.vector.co.jp/authors/VA042397/nes/index.html">NES 研究室</a> という Web サイトが公開してくれている NES 用のありがたいサンプル ROM で描画されたもの。</p>

<p><a href="/images/2018-11-12-rnes-progress-1.png" target="_blank"><img src="/images/2018-11-12-rnes-progress-1.png" alt=""></a></p>

<h2>2018年11月5日</h2>

<p>前日までは背景描画しか実装されていなかったので、ここでスプライトの描画を実装。NES の画面は二つのレイヤーで管理されていて、8×8 ピクセルで画面上に敷き詰められる背景のレイヤーと、同じく 8x8 ピクセル (8×16 にすることも出来る) で画面上の任意の位置に配置できるスプライトのレイヤーが存在する。その内の後者のレイヤーを描画する仕組みの実装をはじめたという話。もしこの辺りの NES の仕組みの話に需要があれば、一段落ついたらブログにでもまとめようかと思っている。</p>

<p>この日の成果として、<a href="http://gikofami.fc2web.com/">ｷﾞｺ猫でもわかるファミコンプログラミング</a> という Web サイトで公開されている、1つのスプライトデータを画面左上付近に描画する ROM が動くようになった。</p>

<p><a href="/images/2018-11-12-rnes-progress-2.png" target="_blank"><img src="/images/2018-11-12-rnes-progress-2.png" alt=""></a></p>

<h2>2018年11月6日</h2>

<p>ターミナル上で動かしているので、標準入力からキーボード入力を取れるだろうと思い、WASD で上下左右に動くためのキーパッドを実装した。しかし改行を入力するまでターミナルが入力を受け付けてくれないので、 S → Enter や D → Enter みたいな入力を強いられるつらい仕様に。</p>

<p><a href="/images/2018-11-12-rnes-progress-3.gif" target="_blank"><img src="/images/2018-11-12-rnes-progress-3.gif" alt=""></a></p>

<h2>2018年11月7日</h2>

<p>nestest という、NES エミュレータ実装界隈で重宝されている CPU テスト用の ROM があるものの、そもそもこの ROM のデータを画面に描画するための実装が足りていない。しかし nestest を正しい実装で動かしたときのログデータが公開されているため、自分の NES エミュレータにもそれと同じ形式でログを出力する機能を実装し、結果を突き合わして不具合を探していくことに。</p>

<p>突き合わせてみると不具合だらけで、酷いものだとビットをマスクするための「value &amp; 0xFF」というコードが誤って「value &amp;&amp; 0xFF」となっていたりした。CPU 命令の実装では、計算結果が負の値だったらレジスタの negative ビットを操作したりというところが上手く実装されていない、という不具合が多かった。</p>

<h2>2018年11月8日</h2>

<p>背景描画をスクロールに対応させたり、DMA 転送という WRAM から VRAM に高速にデータを転送する仕組みを実装したりと色々やった結果、『ｷﾞｺ猫でもわかるファミコンプログラミング』の縦スクロールのレースゲームがそれらしく描画されるように。ただ、道路上に表示されるはずのスプライトが表示されていなくて不安が募る。</p>

<p><a href="/images/2018-11-12-rnes-progress-4.jpg" target="_blank"><img src="/images/2018-11-12-rnes-progress-4.jpg" alt=""></a></p>

<h2>2018年11月9日</h2>

<p>それなりに動くようになってきたので、<a href="/articles/2018-11-09-ruby-nes-emulator">RubyでNESエミュレータをつくりはじめた話</a>を投稿。</p>

<h2>2018年11月10日</h2>

<p>nestest が画面に映るようになり、既にログと突き合わせて不具合修正をがんばっていたので、無事全てのテストに成功していることが確認できた。しかし画面描画周りに不具合があるのか、アスタリスクの記号の位置がずれているのが気になる。</p>

<p><a href="/images/2018-11-12-rnes-progress-5.gif" target="_blank"><img src="/images/2018-11-12-rnes-progress-5.gif" alt=""></a></p>

<h2>2018年11月11日</h2>

<p>nesdev という NES エミュレータの膨大な情報をまとめたありがたい Wiki があり、前述した nestest もそこで紹介されていたものなのだけど、nesdev では nestest 以外のテスト用 ROM も紹介されているので、これを動かして不具合を探していくことに。「このアドレスに対する読み書き時のミラーリングが上手く実装されていないよ」ということが分かるような ROM が提供されていたりして、本当にありがたい。</p>

<p><a href="/images/2018-11-12-rnes-progress-6.jpg" target="_blank"><img src="/images/2018-11-12-rnes-progress-6.jpg" alt=""></a></p>

<h2>2018年11月12日</h2>

<p>吸い出したスーパーマリオブロスの ROM がようやく少し動くように。しかしマリオはよく分からない状態になっているし、背景も描画されていない箇所がそこそこあるしで、完動までまだまだ先は長そう。ちなみに、UNIX の端末を設定するための stty というコマンドを調べた結果、改行を入力しなくてもキーパッドを操作できるようになるなど、微妙な改善も加えられた。</p>

<p>※下の画像はアニメーション GIF になっているけど、容量が大きいせいで環境によってはループしないようになっているので、画像単体で表示すると動くようになるはず。</p>

<p><a href="/images/2018-11-12-rnes-progress-7.gif" target="_blank"><img src="/images/2018-11-12-rnes-progress-7.gif" alt=""></a></p>

<h2>つづく</h2>

<p>以上、ここまで10日間程度の進捗報告でした。</p>

  </div>
</article>

  </main>
</body>
</html>
