<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>Rails/LinkToBlank Copの改善を試みた</title>
  <link href="https://r7kamura.com/articles/2019-04-02-rubocop-rails-link-to-blank" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="RailsのViewではlink_toというメソッドを呼び出すことができ、これはHTMLにおけるa要素に相当する文字列を出力します。">
  <meta property="og:description" content="RailsのViewではlink_toというメソッドを呼び出すことができ、これはHTMLにおけるa要素に相当する文字列を出力します。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Rails/LinkToBlank Copの改善を試みた">
  <meta property="og:url" content="https://r7kamura.com/articles/2019-04-02-rubocop-rails-link-to-blank">
  
  <meta property="og:image" content="https://r7kamura.com/default_og_image.jpg">
  <meta property="twitter:card" content="summary">
  
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura.com</a>
      <ul>
        <li>
          <a href="/links">リンク集</a>
        </li>
        <li>
          <a href="https://www.google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2019-04-02T00:00:00+00:00">2019年04月02日</time>
    <h1>Rails/LinkToBlank Copの改善を試みた</h1>
  </header>
  <div>
    <h2>Rails/LinkToBlank</h2>

<p>RailsのViewではlink_toというメソッドを呼び出すことができ、これはHTMLにおけるa要素に相当する文字列を出力します。このとき、引数が <code>target: '_blank'</code> のように指定されていると、<code>target="_blank"</code> のようにa要素に属性が付与されます。</p>

<p>さて、この手の <code>target="_blank"</code> が付けられたa要素から遷移した先のページでは、遷移元のページを制御することができ、ともすればセキュリティリスクになり得ます（アダルト系の広告等でこの手の技が利用されることが多いですね）。そこで、<code>rel="noopener"</code> という属性を同時に付けておくことで、遷移先のページから制御されることを防げます。link_toメソッドにおいては、<code>rel: 'noopener'</code> というように引数を付けることで対応できます。</p>

<p>link_toメソッドに <code>target: '_blank'</code> が指定されているとき、同時に <code>rel: 'noopener'</code> が指定されているかどうかを検査するために、RuboCopにRails/LinkToBlankというCopがあります。</p>

<p><a href="https://www.rubydoc.info/gems/rubocop/RuboCop/Cop/Rails/LinkToBlank">https://www.rubydoc.info/gems/rubocop/RuboCop/Cop/Rails/LinkToBlank</a></p>

<h2>targetがSymbolだとauto-correct結果がおかしい</h2>

<p>RuboCop v0.65.0からv0.66.0にアップデートしたことにより、これまで検知できていなかったRails/LinkToBlankへの違反がより正確に検知できるようになりました。そして手元のプロジェクトでRails/LinkToBlankへの違反が見つかったため、RuboCop v0.66.0でauto-correctを利用して修正を試みたところ、構文エラーが発生するコードが出力されてしまいました。</p>

<p>どうやら <code>target: :_blank</code> のようにtarget属性がSymbolリテラルで指定されているときにauto-correctに失敗してしまうようです。</p>

<p>Symbolでの指定自体がRuboCop的にサポートしていない状況だったらどうしようかと思いましたが、targetがSymbolでも違反を正しく検知できるというテストケースが書かれているのを発見したので、多分サポート範囲内だろうということでauto-correctの修正を試みました。</p>

<p><a href="https://github.com/rubocop-hq/rubocop/pull/6868">https://github.com/rubocop-hq/rubocop/pull/6868</a></p>

<h2>relがSymbolだと誤検知される</h2>

<p>前述のPull Requestがmergeされると、<code>target: :_blank</code> が指定されているときはauto-correctによって <code>rel: :noopener</code> が指定されるようになるのですが、検査時にはrelは文字列リテラルであることしか想定されていないようで、自動修正後のコードから違反が誤検出されるようになってしまいました。そこで、relにSymbolリテラルも許可するように修正を試みました。</p>

<p><a href="https://github.com/rubocop-hq/rubocop/pull/6869">https://github.com/rubocop-hq/rubocop/pull/6869</a></p>

  </div>
</article>

  </main>
</body>
</html>
