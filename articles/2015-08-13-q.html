<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>FluctとAPI Gateway+LambdaでWebアプリをつくる</title>
  <link href="https://r7kamura.com/articles/2015-08-13-q" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="Fluctというツールを使いながら、Amazon API GatewayとAWS Lambdaを組み合わせてWebアプリをつくる方法について説明します。">
  <meta property="og:description" content="Fluctというツールを使いながら、Amazon API GatewayとAWS Lambdaを組み合わせてWebアプリをつくる方法について説明します。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="FluctとAPI Gateway+LambdaでWebアプリをつくる">
  <meta property="og:url" content="https://r7kamura.com/articles/2015-08-13-q">
  
  <meta property="og:image" content="https://r7kamura.com/default_og_image.jpg">
  <meta property="twitter:card" content="summary">
  
</head>
<body>
  <header>
    <nav>
      <p>
        <a href="/">r7kamura.com</a>
      </p>
      <ul>
        <li>
          <a href="/links">リンク集</a>
        </li>
        <li>
          <a href="https://www.google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2015-08-13T00:00:00+00:00">2015年08月13日</time>
    <h1>FluctとAPI Gateway+LambdaでWebアプリをつくる</h1>
  </header>
  <div>
    <p><a href="https://github.com/r7kamura/fluct">Fluct</a>というツールを使いながら、Amazon API GatewayとAWS Lambdaを組み合わせてWebアプリをつくる方法について説明します。JavaScriptで実装でき、自動的にそこそこスケールし、Amazon EC2などで自前のWebサーバを常時稼働させておく必要なく、基本的にはリクエスト回数と転送量に応じてのみ課金されるようなWebアプリの環境を手に入れることが目的です。</p>

<h2>Amazon API Gatewayとは</h2>

<p><a href="http://aws.amazon.com/jp/api-gateway/">Amazon API Gateway</a>はWeb APIを簡単に作成・公開・管理するためのサービスです。2015年7月9日に新しく公開されました。Qiitaにも既に<a href="http://qiita.com/tags/apigateway">いくつかの記事</a>が投稿されています。それ自身はプロキシとして振る舞い、バックエンドのサービスが提供するデータや機能にアクセスするための入口として振る舞います。</p>

<p>バックエンドのサービスには、<a href="http://aws.amazon.com/jp/lambda/">AWS Lambda</a>か、あるいはHTTP経由でアクセスできるWebアプリケーションを指定できます。豪華なHTTPプロキシとして振る舞うという捉え方が適しているかもしれません。<code>GET /foo</code> などのエンドポイントを指定して、</p>

<ul>
<li>どんなHTTPリクエストを許可するか</li>
<li>どのサービスにプロキシするか</li>
<li>サービスにどんな入力を渡すか</li>
<li>サービスからの出力をどうHTTPレスポンスに変換するか</li>
</ul>

<p>などの項目を設定しておくことで、実際にHTTPリクエストが来るとそのように振る舞ってくれます。他に特筆すべき機能として、定義したエンドポイント用にAndroidやiOS用のSDKを自動生成してくれたり、複数の環境にデプロイしたりという機能がありますが、詳しくはAmazon API Gatewayの <a href="http://aws.amazon.com/jp/api-gateway/faqs/">よくある質問</a> などを見てみてください。</p>

<h2>Fluctとは</h2>

<p>FluctはAmazon API GatewayとAWS Lambdaを組み合わせて1つのWebアプリをつくるのを支援するためのツールです。AWS Lambdaを使う場合はNode.jsかJava 8の環境で動くコードを書くことになるので、これに合わせてFluctはNode.jsで実装されています。Webアプリの開発者は、開発に使う環境にFluctをインストールし、<code>fluct</code> というコマンドを利用しながら開発を進めていくことになります。</p>

<h2>Fluctをインストールする</h2>

<p>Fluctは、Node.jsのパッケージ管理ツールである<a href="https://www.npmjs.com/">npm</a>経由でインストールできます。FluctはNode.js v0.12以上で動作することを確認しているので、Fluctをインストールする環境にNode v0.12以上がインストールされていない場合は、まずそちらを先にインストールしてください。例えば、特に何もインストールしていない状態のMac OS XにHomebrew経由でNode.jsをインストールしたあとにFluctをインストールするには、以下のコマンドを実行します。手元の環境に合わせて適宜実行するコマンドを選んでください。</p>

<pre><code>$ ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
$ brew install node
$ npm install fluct --global
</code></pre>

<h2>新しくアプリをつくる</h2>

<p>Fluctを使って新しくアプリをつくってみます。<code>fluct new &lt;name&gt;</code> というコマンドを利用すれば、現在のディレクトリに新しいアプリ用のディレクトリが生成されます。</p>

<pre><code>$ fluct new myapp
Created ./myapp
Created ./myapp/.gitignore
Created ./myapp/actions
Created ./myapp/actions/.keep
Created ./myapp/package.json
</code></pre>

<p>アプリという単位は、1つのプロジェクトの単位であり、Amazon API Gateway上での「Restapi」という単位と一致します。Restapiごとに <code>https://{restapi}.execute-api.{region}.amazonaws.com/{stage}/</code> というURLが割り当てられます。このURLには独自ドメインを割り当てられます。ドメインを分けたい単位でアプリを分けるというのが良いと思います。</p>

<h2>Actionを追加する</h2>

<p>試しに、<code>GET /ping</code> にアクセスすると <code>"pong"</code> が返ってくるというサンプルをつくることにします。Fluctでは、この <code>GET /ping</code> のようなエンドポイントの単位のことをactionと呼んでいます。RailsなどのWebアプリケーションフレームワークにおける、ControllerのActionに相当する部分です。今回は、<code>GET /ping</code> のためにshow_pingという名前のactionをつくることにします。アプリのディレクトリで <code>fluct generate &lt;name&gt;</code> というコマンドを実行すると、actionに必要なファイル群が生成されます。</p>

<pre><code>$ cd myapp
$ fluct generate show_ping
Created ./actions/show_ping
Created ./actions/show_ping/index.js
Created ./actions/show_ping/package.json
</code></pre>

<h2>Actionのパスを変更する</h2>

<p>Actionごとに、package.json というファイルにそのactionが担当するエンドポイントの情報が定義されています。自動生成されたファイルには <code>GET /dummy</code> というエンドポイントが設定されているので、これを <code>GET /ping</code> に変更します。</p>

<pre><code>$ vi actions/show_ping/package.json
$ cat actions/show_ping/package.json
{
  "name": "show_ping",
  "private": true,
  "fluct": {
    "arn": null,
    "contentType": "text/html",
    "httpMethod": "GET",
    "path": "/ping"
  }
}
</code></pre>

<h2>Actionの実装を変更する</h2>

<p>Actionがリクエストを受け取ったときにどう振る舞うかは、個々のactionのindex.jsというファイルに定義されています。これは最終的にAWS LambdaにアップロードされてNode.jsで実行されることになるファイルです。context.succeedの引数がレスポンスボディになるので、これを書き換えます。</p>

<pre><code>$ vi actions/show_ping/index.js
$ cat actions/show_ping/index.js
exports.handler = function (event, context) {
  context.succeed('pong');
};
</code></pre>

<h2>IAM Roleを設定する</h2>

<p>show_pingのパスと実装を変更したので、これをAWS LambdaとAmazon API Gatewayに反映させれば完了です。Amazon API GatewayからAWS Lambda上に置かれたshow_pingという関数を呼び出して実行することになりますが、AWSの制約上、予めshow_pingという関数にAmazon API Gatewayからの呼び出しを許可する権限を与えておかなければ実行できないようになっています。その権限管理の仕組みとしてIAM Roleを使うことになっているため、まずIAM Roleを用意する必要があります。</p>

<p>IAM Roleは、AWSマネジメントコンソールのIAMサービスから作成できます。AWSLambdaBasicExecutionRoleというポリシーを持ったIAM Roleを新たに作成し、そのIAM RoleのARNと呼ばれる識別子を手に入れ、Fluctのアプリのpackage.jsonに設定します。かなり面倒ですが、全てのactionで同じIAM Roleを利用するので、この作業は一度だけやれば大丈夫です。この辺、権限がある場合は自動で設定されるようにしたいですね。</p>

<pre><code>$ vi package.json
$ cat package.json
{
  "name": "myapp",
  "private": true,
  "fluct": {
    "restapiId": null,
    "roleArn": "arn:aws:iam::012345678912:role/myExampleRole"
  }
}
</code></pre>

<h2>デプロイしてみる</h2>

<p><code>fluct deploy</code> というコマンドを使えば、AWS Lambdaへのコードのアップロード、Amazon API Gateway上での設定などを全部やってくれます。このときAWSのAPIを利用しますが、<a href="http://docs.aws.amazon.com/AWSJavaScriptSDK/guide/node-configuring.html">AWS SDKの認証の仕組み</a>を利用するので、<code>~/aws/.credentials</code> か環境変数に認証情報が設定されている必要があります。</p>

<pre><code>$ fluct deploy
Created zip file: ./actions/show_ping/lambda.zip
Uploaded function: show_ping
Updated endpoint: GET /ping
Deployed: https://123ge4oabj.execute-api.us-east-1.amazonaws.com/production
</code></pre>

<h2>動作を確認する</h2>

<p>デプロイが問題なく完了したら、show_pingのactionが正しく動作しているか確認してみましょう。</p>

<pre><code>$ curl https://123ge4oabj.execute-api.us-east-1.amazonaws.com/production/ping -i
HTTP/1.1 200 OK
Content-Type: text/html
Content-Length: 13
Connection: keep-alive
Date: Tue, 11 Aug 2015 19:22:33 GMT
x-amzn-RequestId: 512f8391-405e-11e5-acef-2125b850bbe1
X-Cache: Miss from cloudfront
Via: 1.1 6145a790e7dca1c0c567e1f5decce786.cloudfront.net (CloudFront)
X-Amz-Cf-Id: 5LvHm6SaEQnTj1ubwlCvJhew6G86AU6FFEGB2ic3FI-r7kwNfwDCXg==

pong
</code></pre>

<p>はい。</p>

<h2>おわり</h2>

<p>以上で、Fluctを使いながらAmazon API GatewayとAWS Lambdaを組み合わせてWebアプリをつくる方法はひとまずおしまいです。より詳しい使い方を見たい場合は、<a href="https://github.com/r7kamura/fluct">r7kamura/fluct</a> の説明を見ると良いでしょう。また、サンプルアプリの <a href="https://github.com/r7kamura/fluct-example">r7kamura/fluct-example</a> にはテンプレートエンジンやMarkdownパーサを利用してHTMLを描画するサンプルが用意されているので、こちらも参考になるかもしれません。</p>

  </div>
</article>

  </main>
</body>
</html>
