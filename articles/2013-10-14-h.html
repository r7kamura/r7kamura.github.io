<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>体育の日って高速に唱えるとテストの日に聴こえる</title>
  <link href="https://r7kamura.com/articles/2013-10-14-h" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="最近書いているWebアプリは、HTTPリクエストを送ってレスポンスと状態をテストする、というテストだけ書くようにしてる。">
  <meta property="og:description" content="最近書いているWebアプリは、HTTPリクエストを送ってレスポンスと状態をテストする、というテストだけ書くようにしてる。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="体育の日って高速に唱えるとテストの日に聴こえる">
  <meta property="og:url" content="https://r7kamura.com/articles/2013-10-14-h">
  
  <meta property="og:image" content="https://r7kamura.com/default_og_image.jpg">
  <meta property="twitter:card" content="summary">
  
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura.com</a>
      <ul>
        <li>
          <a href="/articles">一覧</a>
        </li>
        <li>
          <a href="https://www.google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2013-10-14T00:00:00+00:00">2013年10月14日</time>
    <h1>体育の日って高速に唱えるとテストの日に聴こえる</h1>
  </header>
  <div>
    <ul>
<li><a href="http://hitode909.hatenablog.com/entry/2013/10/14/094604">テスト書きすぎ問題 - hitode909の日記</a></li>
<li><a href="http://hakobe932.hatenablog.com/entry/2013/10/14/120345">階層が増えるとテストが増える - はこべブログ ♨</a></li>
<li><a href="http://shibayu36.hatenablog.com/entry/2013/10/14/122925">テストと対応関係 - $shibayu36-&gt;blog;</a></li>
</ul>

<p>最近書いているWebアプリは、HTTPリクエストを送ってレスポンスと状態をテストする、というテストだけ書くようにしてる。リクエストするとブログエントリを返す、というサービスだとこういう風なテストを書いてる。(HTMLを返すようにすると話が広がって説明が面倒なのでJSONを返すAPIで説明する)</p>

<pre><code>describe "Entry resource" do let(:params) do {} end let(:env) do { "HTTP\_AUTHORIZATION" =\&gt; "Bearer: #{access\_token.token}" } end let(:access\_token) doAccessToken.make(user: user) end let(:user) doUser.make end let(:entry) doEntry.make(author: author) end let(:author) doUser.make end describe "GET /entries/:id" do context "with deleted entry's id" do before do entry.delete end it "returns 404" do get "/entries/#{entry.id}", params, env response.status.should == 404endend context "with other's draft entry's id" do before do entry.update\_attributes(published\_at: nil) end it "returns 404" do get "/entries/#{entry.id}", params, env response.status.should == 404endend context "with own draft entry's id" do before do entry.update\_attributes(published\_at: nil) end let(:author) do user end it "returns 200" do get "/entries/#{entry.id}", params, env response.status.should == 200endend context "with published entry's id", :autodoc do it "returns the entry" do get "/entries/#{entry.id}", params, env response.status.should == 200 response.headers["Content-Type"].should == "application/json; charset=utf-8" response.body.should be\_json( "id" =\&gt; entry.id, "title" =\&gt; entry.title, "body" =\&gt; entry.body, ) endendendend
</code></pre>

<p>言語化したことなかったけどこういう慣習があると思う。</p>

<ul>
<li>1テストケースで1リクエスト</li>
<li>内部でRouter/Dispatcher、Controller、Modelがどうなっているかというのはテストしていない</li>
<li>テストケースのネストの深さを均一にする</li>
<li>似たテストケースが増えてきても似たようなコードを真面目に書く</li>
<li>テストのメッセージに規則を持たせる</li>
<li>例: 1階層目のdescribeに与える文字列は"リソース名 resource"という形式</li>
<li>例: 2階層目のdescribeに与える文字列は"METHOD Path"という形式</li>
<li>例: contextに与える文字列は"with ..."で始める</li>
<li>例: itに与える文字列は三人称単数系で始める</li>
<li>正常系にタグを付ける</li>
</ul>

<p>これまで色々な規則性を持たせてテストを書くことを試してきたけど、他のは進化の過程で淘汰されて、最終的にこの慣習が最も長く生き残った。ドキュメント形式でのテストの出力結果を見ると大体仕様が分かって便利、という側面もあるけど、このテストを実行すると<a href="https://github.com/r7kamura/autodoc">謎の技術</a>でAPIドキュメントがMarkdownで生成されるようになっているというのが良いところだと思う。全てこの規則の上に成り立っている。正常系用のタグが付いているテストケースごとに、次の情報が記載される。</p>

<ul>
<li>Method</li>
<li>URL</li>
<li>渡せる入力値</li>
<li>何が起こるか</li>
<li>サンプルリクエスト</li>
<li>サンプルレスポンス</li>
</ul>

<p><a href="https://github.com/r7kamura/autodoc/blob/master/spec/dummy/doc/recipes.md">https://github.com/r7kamura/autodoc/blob/master/spec/dummy/doc/recipes.md</a></p>

<p>開発者用にアプリ側にAPI documentationみたいページを用意してあって、アクセスするとこのMarkdownファイルをいい感じに表示するようにしてる。テストを書くとドキュメントが生成されるので、テストを書くことに対する見返りが大きい。ControllerやDispatcherの内部実装は全くテストしていないけど、C0 coverageは99.0%ぐらいあった気がする。今のところこの方法で困っていることが特に無いのだけど、敢えて言うなら仕様バグみたいなものが見つからないので、関心の埒外の出来事が起きて爆発する可能性がある。だから、テストの出力結果を睨みながら、この仕様はおかしい、ということに人間が思い至る必要がある。</p>

<p>落ちはないけど、JSON API用にドキュメントを自動生成する実装があるので良かったら参考にどうぞ。<br>
<a href="https://github.com/r7kamura/autodoc">https://github.com/r7kamura/autodoc</a></p>

  </div>
</article>

  </main>
</body>
</html>
