<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>amakanのCIをShippableに移行した</title>
  <link href="https://r7kamura.com/articles/2017-01-14-h" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="https://amakan.net/ のこの辺の改善の続き。">
  <meta property="og:description" content="https://amakan.net/ のこの辺の改善の続き。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="amakanのCIをShippableに移行した">
  <meta property="og:url" content="https://r7kamura.com/articles/2017-01-14-h">
  
  <meta property="og:image" content="https://cdn-ak.f.st-hatena.com/images/fotolife/r/r7kamura/20170114/20170114143123.png">
  <meta property="twitter:card" content="summary_large_image">
  
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura.com</a>
      <ul>
        <li>
          <a href="/links">リンク集</a>
        </li>
        <li>
          <a href="https://www.google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2017-01-14T00:00:00+00:00">2017年01月14日</time>
    <h1>amakanのCIをShippableに移行した</h1>
  </header>
  <div>
    <p><a href="https://amakan.net/">https://amakan.net/</a> のこの辺の改善の続き。</p>

<ul>
<li><a href="http://r7kamura.hatenablog.com/entry/2016/12/08/001413">amakanをUnicornからPumaに移行した - ✘╹◡╹✘</a></li>
<li><a href="http://r7kamura.hatenablog.com/entry/2016/12/08/061203">amakanでyarnを使うようにした - ✘╹◡╹✘</a></li>
<li><a href="http://r7kamura.hatenablog.com/entry/2016/12/09/201115">amakanでRuby 2.3.3を使うようにした - ✘╹◡╹✘</a></li>
<li><a href="http://r7kamura.hatenablog.com/entry/2016/12/10/221600">amakanを Ruby 2.3.3 から 2.4.0-preview3 に移行した - ✘╹◡╹✘</a></li>
<li><a href="http://r7kamura.hatenablog.com/entry/2016/12/13/074119">amakanのフロントエンドを色々改善した - ✘╹◡╹✘</a></li>
<li><a href="http://r7kamura.hatenablog.com/entry/2016/12/18/212642">amakanをSidekiqに移行した - ✘╹◡╹✘</a></li>
<li><a href="http://r7kamura.hatenablog.com/entry/2016/12/21/010420">amakanの開発環境をDockerに移行した - ✘╹◡╹✘</a></li>
<li><a href="http://r7kamura.hatenablog.com/entry/2016/12/26/041931">amakanの本番環境をDockerに移行した - ✘╹◡╹✘</a></li>
<li><a href="http://r7kamura.hatenablog.com/entry/2017/01/02/223425">amakanをDocker化した感想 - ✘╹◡╹✘</a></li>
</ul>

<hr>

<figure><a href="https://cdn-ak.f.st-hatena.com/images/fotolife/r/r7kamura/20170114/20170114143123.png" target="_blank"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/r/r7kamura/20170114/20170114143123.png" alt="f:id:r7kamura:20170114143123p:plain" title="f:id:r7kamura:20170114143123p:plain"></a><figcaption>f:id:r7kamura:20170114143123p:plain</figcaption></figure>

<h2>CircleCIからShippableに移行した</h2>

<p><a href="http://r7kamura.hatenablog.com/entry/2017/01/02/223425">amakanをDocker化した感想 - ✘╹◡╹✘</a> で触れた「CIのビルドに時間が掛かるようになった」という問題に対応するため、利用するCIサービスを<a href="https://circleci.com/">CircleCI</a>から<a href="https://app.shippable.com">Shippable</a>に移行した。他の候補としてTravisCI、Werckerなどを見たけれど、ShippableはDockerのキャッシュに上手く対応しているということで、これを選択した。</p>

<h2>ビルドに掛かる時間が500秒から60秒になった</h2>

<p>CIの中では、こういうことをやっている。</p>

<ul>
<li>Node.js用のDockerイメージをビルドする</li>
<li>Node.js用のDockerイメージでテストを実行する</li>
<li>Node.js用のDockerイメージでCSSとJavaScriptを生成する</li>
<li>Rails用のDockerイメージをビルドする (直前で生成したCSSとJavaScriptを含めつつ)</li>
<li>Rails用のDockerイメージでテストを実行する</li>
<li>Rails用のDockerイメージをAmazon ECRにPushする</li>
</ul>

<p>CircleCIからShippableに移行したことで、過去にビルドしたDockerイメージのキャッシュが再利用できるようになったので、それぞれのDockerイメージをビルドする部分が一瞬で終わるようになった。</p>

<h2>Volumeを使おうとすると複雑</h2>

<p>上述の処理を実現するために、これまで <code>--volume $(pwd)/public/assets:/app/public/assets</code> というオプションを利用していたが、<code>--volumes-from ${SHIPPABLE_CONTAINER_NAME}</code> というようにデータボリュームを用意する方法に変更する必要があった。<code>--volume</code> オプションを指定してもホスト側とは何も共有されない (エラーも出ない) という挙動を元に原因を調べるのに時間が掛かった。</p>

<h2>UIが分かりづらい</h2>

<p>他のCIサービスと比べると、UIが見づらくて使いづらい。良い機能を提供していると思うので、余計に勿体無く感じる。</p>

<h2>無料ではプライベートリポジトリは1つまで</h2>

<p>無料では1つまでしかプライベートリポジトリが利用できないので、高速化したいamakanだけとりあえずShippableで運用してみている。</p>

<h2>設定例</h2>

<p>amakanのshippable.ymlです。</p>

<pre><code>language: nonebuild:pre\_ci\_boot:options: -v /app/public/assets ci:- export DOCKER\_TAG=${ECR\_REPOSITORY\_URL}:${BUILD\_NUMBER} - docker build --file ./docker/node/Dockerfile --tag amakan\_node . - docker run amakan\_node yarn run test - docker run --volumes-from ${SHIPPABLE\_CONTAINER\_NAME} amakan\_node yarn run build - cp /app/public/assets/\* public/assets/ - docker build --file ./docker/rails/Dockerfile --tag ${DOCKER\_TAG} . - docker run ${DOCKER\_TAG} bundle exec rake test post\_ci:- \&gt; if [["${BRANCH}" == "master"]]; then sudo docker push ${DOCKER\_TAG} fiintegrations:hub:- integrationName: ecr type: ecr region: ap-northeast-1 branches:only:- master notifications:- integrationName: email type: email on\_success: never on\_failure: never on\_pull\_request: never - integrationName: slack type: slack on\_failure: always on\_success: always recipients:- "#shippable"
</code></pre>

  </div>
</article>

  </main>
</body>
</html>
