<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>MVCの話もっとしてほしい</title>
  <link href="https://r7kamura.com/articles/2012-01-06-h" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="昨日バイト先で男子しか参加しない女子会して、開発の仕方どうするかみたいな話合いしたの面白かった。">
  <meta property="og:description" content="昨日バイト先で男子しか参加しない女子会して、開発の仕方どうするかみたいな話合いしたの面白かった。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="MVCの話もっとしてほしい">
  <meta property="og:url" content="https://r7kamura.com/articles/2012-01-06-h">
  
  <meta property="og:image" content="http://dl.dropbox.com/u/5978869/image/20120107_050819.png">
  <meta property="twitter:card" content="summary_large_image">
  
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura.com</a>
      <ul>
        <li>
          <a href="/articles">一覧</a>
        </li>
        <li>
          <a href="https://www.google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2012-01-06T00:00:00+00:00">2012年01月06日</time>
    <h1>MVCの話もっとしてほしい</h1>
  </header>
  <div>
    <p>昨日バイト先で男子しか参加しない女子会して、開発の仕方どうするかみたいな話合いしたの面白かった。</p>

<h3>押し付け合い回避のためにもレイヤ</h3>

<p>趣味や価値観をリアルタイムで押し付け合うのはギスギスして良くないが、話し合うべきときを設けてやはり定期的に話し合うべきだと思った。コード内のインターフェースが少ないと、そういう押し付け合いが起こる可能性が多く出てきたり、それを避けるために心理的に間違った方向に実装しそうで良くない。データAPIが薄くてコントローラに書くことが増えると、コントローラ内で押し付け合いやすいみたいなそういう。レイヤ分けて「はい俺バリア〜ここからさき俺の実装〜〜」みたいなのが良さそう。</p>

<h3>MVC界隈の知識源</h3>

<p>MVC関係の話、まとまった情報源が無くて、Togetterかブログエントリあたりで適当にまとめられていることが多い。PoEAA(Patterns of Enterprise Application)が良いという噂を聞いたことあるけど、同時に邦訳が酷いという話も聞く。まとまった情報源が無くてみんな困ってそう。MVCの話、大体の人がRailsやPHPのDisをしつつMの話をするという感じで、最悪の例に対してしかあまり語られてない気がする。考え方の良し悪しは別に気にしないから、MVCの話もっとしてほしい。世の中にMVCの専門家みたいなひと実はいなさそう。</p>

<h3>DataMapper</h3>

<p><a href="http://dl.dropbox.com/u/5978869/image/20120107_050819.png" target="_blank"><img src="http://dl.dropbox.com/u/5978869/image/20120107_050819.png" alt=""></a></p>

<p>最近触ってるMVCのプロダクトだと、Model(用に作られたクラス)がDBアクセスを一切しないという形になっていて、テストがしやすいしコードが分かりやすくてすごく良い。なぜコードが分かりやすいのだろうと思ったけど、ごく単純なことしかしてないからだと思う。しかしControllerのコードが膨れ上がって見通しが悪いので、どうにかしたい感も高い。</p>

<p>今まで触ってたORMは全部ActiveRecordパターンのModelだったけど、それだとDBと依存しすぎてテストとか超書きづらそうだし実装も厚くなりそう。純粋なオブジェクトを提供するクラス + includeするだけでDBへのアクセスが可能になる、みたいなものがあれば便利である可能性が高いなとか考えてたけど、結局ActiveRecordと同じことになりそうな不安もある。探していたらDataMapperパターンというのがHitしたので多分こういうのだと思う。上図だと、純粋なオブジェクトを提供するクラスがStoreで、includeするだけでDBへのアクセスが可能になるクラスがStoreMapper。</p>

<p>DBとの接続部分はMapperに追いやって、DBから取得したデータ自体はDBとは無関係のModelに紐付ける、という感じが良さそう。でもModelが別のModelを操作する処理とかを実装するには、結局ModelがMapperのメソッドを叩くしかなくなってModelとDBとの依存性高まりそうだと思ったけど、Mapperが提供すべきPublicメソッドという規約(=JavaのInterfaceみたいなの)があれば、Mapperを違うデータソースに差し替えても動く。でも全体的によく分からないモヤモヤした感じがある。何をしたいのかすらあんまりわかってない。モデルとDB接続が密結合でテストしにくいのを解消したいのか、Controllerのコードが膨れ上がっていて見通しが悪いのを解決したいのか、読むコードを減らしたいのか、どれの優先度を高めればいいのだろう。全部解決しようとして混線している気がする。でも全部解決したい。</p>

<p>DataMapperを採用する利点として、次のような内容を考えた。</p>

<ul>
<li>データソースをDBからKVSに変えるなどの切り替えが容易</li>
<li>データソース操作のロジック変更が容易(論理削除実装とか)</li>
<li>テスト用Mapperを用意すればテスト中に何度もMockを生成する必要がない</li>
<li>DB操作 / モデルの行うべき処理(ロジック) の定義場所やテストが区別される</li>
<li>テスト用Mapperに切り替えるなどしてモデルのロジックのテストがDBと独立できる</li>
</ul>

<p>もう少しDataMapper界隈の良い実装について調べたい。</p>

  </div>
</article>

  </main>
</body>
</html>
