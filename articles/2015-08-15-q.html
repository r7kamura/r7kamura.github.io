<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>API Gatewayへの入力値にLambdaからアクセスする</title>
  <link href="https://r7kamura.com/articles/2015-08-15-q" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="Amazon API GatewayとAWS Lambdaを組み合わせて利用しているときに、リクエストヘッダやURLクエリパラメータなどの入力値にLambdaのコードからアクセスできるようにする方法について説明します。">
  <meta property="og:description" content="Amazon API GatewayとAWS Lambdaを組み合わせて利用しているときに、リクエストヘッダやURLクエリパラメータなどの入力値にLambdaのコードからアクセスできるようにする方法について説明します。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="API Gatewayへの入力値にLambdaからアクセスする">
  <meta property="og:url" content="https://r7kamura.com/articles/2015-08-15-q">
  
  <meta property="og:image" content="https://qiita-image-store.s3.amazonaws.com/0/4365/65d9c0c7-0686-c9b9-7670-6feeeb9a97b2.png">
  <meta property="twitter:card" content="summary_large_image">
  
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura.com</a>
      <ul>
        <li>
          <a href="/articles">一覧</a>
        </li>
        <li>
          <a href="https://www.google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2015-08-15T00:00:00+00:00">2015年08月15日</time>
    <h1>API Gatewayへの入力値にLambdaからアクセスする</h1>
  </header>
  <div>
    <p>Amazon API GatewayとAWS Lambdaを組み合わせて利用しているときに、リクエストヘッダやURLクエリパラメータなどの入力値にLambdaのコードからアクセスできるようにする方法について説明します。</p>

<h2>Integration Requestを選ぶ</h2>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/4365/65d9c0c7-0686-c9b9-7670-6feeeb9a97b2.png" target="_blank"><img src="https://qiita-image-store.s3.amazonaws.com/0/4365/65d9c0c7-0686-c9b9-7670-6feeeb9a97b2.png" alt="image"></a></p>

<h2>Mapping Templatesを選ぶ</h2>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/4365/09eaa051-5d90-c624-9e75-ce02120e7cc9.png" target="_blank"><img src="https://qiita-image-store.s3.amazonaws.com/0/4365/09eaa051-5d90-c624-9e75-ce02120e7cc9.png" alt="image"></a></p>

<h2>テンプレートを作成する</h2>

<p>application/json用のテンプレートを作成します。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/4365/4279da3a-0d53-68de-058e-f180ee60aaf5.png" target="_blank"><img src="https://qiita-image-store.s3.amazonaws.com/0/4365/4279da3a-0d53-68de-058e-f180ee60aaf5.png" alt="image"></a></p>

<h2>テンプレートを編集する</h2>

<p>内容は以下の通りです。執筆時点で <a href="http://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html">API Gatewayのドキュメント</a> で説明されている全ての値を参照できるようにしてみました。このテンプレートはVTLという言語で記述することになっているので、詳しく知りたい人は <a href="http://velocity.apache.org/engine/devel/user-guide.html">ユーザガイド</a> を見ると良いです。</p>

<pre><code>{
  "accountId": "$context.identity.accountId",
  "apiId": "$context.apiId",
  "apiKey": "$context.identity.apiKey",
  "caller": "$context.identity.caller",
  "headers": {
#foreach( $key in $input.params().header.keySet() )
    "$key": "$input.params().header.get($key)"#if( $foreach.hasNext ),#end
#end
  },
  "httpMethod": "$context.httpMethod",
  "path": "$context.resourcePath",
  "pathParameters": {
#foreach( $key in $input.params().path.keySet() )
    "$key": "$input.params().path.get($key)"#if( $foreach.hasNext ),#end
#end
  },
  "queryParameters": {
#foreach( $key in $input.params().querystring.keySet() )
    "$key": "$input.params().querystring.get($key)"#if( $foreach.hasNext ),#end
#end
  },
  "requestId": "$context.requestId",
  "requestParameters": $input.json('$'),
  "resourceId": "$context.resourceId",
  "sourceIp": "$context.identity.sourceIp",
  "stage": "$context.stage",
  "user": "$context.identity.user",
  "userAgent": "$context.identity.userAgent",
  "userArn": "$context.identity.userArn"
}
</code></pre>

<h2>おわり</h2>

<p>以上の設定を反映させると、Lambdaのeventオブジェクトとしてこれらの値が渡されるようになります。</p>

<pre><code class="js">exports.handler = function (event, context) {
  context.succeed(event);
};
</code></pre>

  </div>
</article>

  </main>
</body>
</html>
