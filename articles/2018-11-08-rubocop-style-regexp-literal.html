<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>RuboCopのStyle/RegexpLiteralを改善するPull Requestを送ったときの話</title>
  <link href="https://r7kamura.com/articles/2018-11-08-rubocop-style-regexp-literal" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="https://github.com/rubocop-hq/rubocop/pull/6457 を書いたときの話。">
  <meta property="og:description" content="https://github.com/rubocop-hq/rubocop/pull/6457 を書いたときの話。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="RuboCopのStyle/RegexpLiteralを改善するPull Requestを送ったときの話">
  <meta property="og:url" content="https://r7kamura.com/articles/2018-11-08-rubocop-style-regexp-literal">
  
  <meta property="og:image" content="https://r7kamura.com/default_og_image.jpg">
  <meta property="twitter:card" content="summary">
  
</head>
<body>
  <header>
    <nav>
      <p>
        <a href="/">r7kamura.com</a>
      </p>
      <ul>
        <li>
          <a href="/links">リンク集</a>
        </li>
        <li>
          <a href="https://www.google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2018-11-08T00:00:00+00:00">2018年11月08日</time>
    <h1>RuboCopのStyle/RegexpLiteralを改善するPull Requestを送ったときの話</h1>
  </header>
  <div>
    <p><a href="https://github.com/rubocop-hq/rubocop/pull/6457">https://github.com/rubocop-hq/rubocop/pull/6457</a> を書いたときの話。</p>

<h2>Ruby の正規表現リテラル</h2>

<p>Ruby には正規表現オブジェクトを生成するためのリテラルがあって、例えば「foo を含む文字列」と一致させるには /foo/ というように書ける。リテラルというのは、プログラミング言語において、値を直接コード内に記述した文法上の単位のことですね。
例えば <a href="https://patreon.com/r7kamura">https://patreon.com/r7kamura</a> のような Patreon の URL に一致させたい場合は、<code>/https://\/\.patreon\.com/.+/</code> のような感じで、エスケープのせいで少し分かりづらい表記になってしまう。正規表現リテラルの開始記号と終了記号にスラッシュを使うことになっているので、スラッシュを含む文字列と一致させたい正規表現を記述したいときは「これは正規表現リテラルを囲むためのスラッシュじゃないよ」ということを伝える必要があって、「<code>\/</code>」のように書かないといけない。</p>

<p>そこで、Ruby では <code>%r|https://patreon\.com/.+|</code> のような書き方もできるようになっている。%r に続いて何か文字を入れると、その文字が開始記号と終了記号になる。しかも <code>%r&lt;https://patreon\.com/.+&gt;</code> のように、開始記号として開き括弧を与えた場合、終了記号は対応する閉じ括弧になってくれる。</p>

<h2>RuboCop の Style/RegexpLiteral</h2>

<p>RuboCop という Ruby 向けの Linter があって、例えば揃っていないインデントや、良くない変数名が使われているコードを検査してくれたり、可能な限り誤りを自動修正してくれたりする。</p>

<p>RuboCop の Lint ルールは色々あるんだけど、その1つに、Style/RegexpLiteral というルールがある。これは正規表現リテラルの書き方を検査するもので、その機能の一部として「スラッシュを含む場合しか %r を使うべきではない」ということを検査してくれる。なんでもかんでも %r を使うんじゃなくて、普通は /foo/ のようにスラッシュを使って正規表現リテラルを書きましょうねということである。</p>

<h2>r7kamura の仕事と Style/RegexpLiteral</h2>

<p>自分はフリーランスとして、Rails や Ruby をアップデートしながらプロジェクトのリファクタリングを専門的に行う仕事を請けている。現在も Rails の仕事を募集しているので、もし縁があれば Twitter でお声がけください。で、その仕事の中で、プロジェクトに RuboCop を導入したり、導入されているけれどほとんどのルールが無効化されていたり放置されたりしている状況を改善したり、という作業も行っている。</p>

<p>その作業の中で、一時的にプロジェクト内で無効化されていた Style/RegexpLiteral を有効化して、違反箇所を RuboCop で自動修正しようとしたところ、幾つか自動修正できない箇所があった。どうやらスラッシュを含む正規表現リテラルは自動修正できないらしく、調べてみるとこの問題は <a href="https://github.com/rubocop-hq/rubocop/issues/5514">https://github.com/rubocop-hq/rubocop/issues/5514</a> で報告されていた。</p>

<h2>RuboCop に送った Pull Request の内容</h2>

<p>調べてみた感じでは、「スラッシュが含まれている場合はエスケープが面倒だから対応していないのだろう」と思われたので、%r を導入する場合には <code>\/</code> を <code>/</code> に、%r を外す場合には <code>/</code> を <code>\/</code> に書き換えるような処理を追加しつつ、スラッシュが含まれている場合でも自動修正を許可するように変更してみた、というのが以下の Pull Request。</p>

<p><a href="https://github.com/rubocop-hq/rubocop/pull/6457">https://github.com/rubocop-hq/rubocop/pull/6457</a></p>

<h2>実装に対する不安</h2>

<p>この文章を書いているときに不具合に気付いたんだけど、%r/foo/ というような書き方もできるので、この場合に限っては /foo/ と同じエスケープ規則を適用しないといけない！テストを追加しつつ Pull Request も修正しておこうと思います。</p>

<p>こういう感じの気付いていないケースがまだありそうで、少し不安に感じている。自動修正って大量の違反を処理していくことがほとんどなので、修正後の差分を逐一確認するのは結構しんどい作業だったりして、変換に不具合があっても気付かないまま git commit してしまうことが多い。自分のせいで誰かのコードに不具合が自動挿入されてしまうかもしれないのは大変怖いので、もう少しテストケースを増やしたり、他に怖いケースが存在しないか考えた方が良いかもしれない。例えば、正規表現リテラルの中の文字列展開の中に <code>\/</code> が含まれていた場合のことなどを考えていました。</p>

<h2>RuboCop の自動修正ロジックの変更方法</h2>

<p>RuboCop では各ルールごとに1つのクラスが用意されているようで、例えば Style/RegexpLiteral だと RuboCop::Cop::Style::RegexpLiteral というクラスが対応している。このクラスに #autocorrect というインスタンスメソッドが実装されていれば、--autocorrect オプションを付けて RuboCop を動かしたときに処理が呼び出されるようです。なので、今回書いた Pull Request では RuboCop::Cop::Style::RegexpLiteral#autocorrect の内容を変更した。</p>

<p><code>#autocorrect</code> には node という引数が渡されるようで、ここには違反検査時に報告された node が渡ってくるようです。なので、ファイル全体を表すノードが渡ってきてしまうとかいう訳ではなくて、ここでは正規表現リテラルを表すノードが渡ってくる。</p>

<p><code>#autocorrect</code> は「引数に corrector を取りながら変換を行う Proc」を返せば良いことになっているようで、今回変更した #autocorrect でも lambda do ... end というリテラルを利用して Proc を生成して返しています。変換は厳密な指定方法になっていて、「このノードの何文字目から何文字目までをこの文字列で置き換える」という情報を corrector.replace メソッドの引数として形式で指示する必要があるので、少し難しく感じるかも。</p>

<h2>RuboCop のコードについての雑感</h2>

<p>RuboCop のコードでは1つのメソッドの ABC 複雑度 (コード内に含まれる Assign, Branch, Condition を元に計算される複雑度) が一定以上だと怒られるようになっていて、今回も素朴に実装を追加したところひどく怒られたので、適当にそれぞれの処理を細かいメソッドに分割した。</p>

<p>現状の RuboCop の設計だと、生存期間の長い Cop クラスのインスタンスに対して autocorrect(node) を呼び出すことで auto-correction を実現するようなインターフェースになっているけれど、これだとインスタンス変数が活用できず、インスタンスメソッドを関数代わりに利用する手続き型的なコードになりがちで窮屈なので、「1つのノードに対する1度の変換」を表すクラスがあると良いのかなと考えていた。</p>

  </div>
</article>

  </main>
</body>
</html>
