<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>RuboCop Problem Matchers</title>
  <link href="https://r7kamura.com/articles/2020-11-10-rubocop-problem-matchers" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="RuboCop Problem MatchersというGitHub Actionをつくった。">
  <meta property="og:description" content="RuboCop Problem MatchersというGitHub Actionをつくった。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="RuboCop Problem Matchers">
  <meta property="og:url" content="https://r7kamura.com/articles/2020-11-10-rubocop-problem-matchers">
  
  <meta property="og:image" content="https://i.imgur.com/AAjpgpih.png">
  <meta property="twitter:card" content="summary_large_image">
  
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura.com</a>
      <ul>
        <li>
          <a href="/links">リンク集</a>
        </li>
        <li>
          <a href="https://www.google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2020-11-10T00:00:00+00:00">2020年11月10日</time>
    <h1>RuboCop Problem Matchers</h1>
  </header>
  <div>
    <p><a href="https://github.com/marketplace/actions/rubocop-problem-matchers">RuboCop Problem Matchers</a>というGitHub Actionをつくった。</p>

<h2>使い方</h2>

<p>GitHub ActionsでRuboCopを実行する前にこれを呼び出しておくと、違反内容が変更差分に注釈として表示されるようになる。</p>

<p>こういう感じで使う。</p>

<pre><code class="yaml">- uses: r7kamura/rubocop-problem-matchers-action@v1
- run: bundle exec rubocop
</code></pre>

<p>こういう感じで表示される。</p>

<figure><a href="https://i.imgur.com/AAjpgpih.png" target="_blank"><img src="https://i.imgur.com/AAjpgpih.png" alt="" title="変更差分に違反内容が表示されている様子"></a><figcaption>変更差分に違反内容が表示されている様子</figcaption></figure>

<p>GitHubの<a href="https://github.com/actions/toolkit/blob/1cc56db0ff126f4d65aeb83798852e02a2c180c3/docs/problem-matchers.md">Problem Matchers</a>という仕組みを利用している。</p>

<h2>注意点</h2>

<p>このような目的でGitHub Actionsを利用するときの注意点に触れておく。</p>

<p><code>pull_request</code> イベントを起点に動かす場合、<code>actions/checkout</code> はそのPull Requestが生成しようとしているmerge commitをチェックアウトする。これだとLinter等から報告されるコードの位置がPull Requestの差分で表示しているものとズレてしまう場合があるので、この用途で使う場合はPull RequestのHEADをチェックアウトするように設定した方が良い。</p>

<pre><code class="yaml">- uses: actions/checkout@v2
  with:
    ref: ${{ github.event.pull_request.head.sha }}
</code></pre>

<p>ちなみに、このように指定しても <code>push</code> 契機での実行時にも特に問題無く動いてくれるので、その点は心配無い。</p>

<hr>

<p>今回取り上げたRuboCop Problem Matchersのような、Problem Matchersを利用したものをつくる開発者向けに細かい情報を書いておく。</p>

<h2>エスケープシーケンス</h2>

<p>GitHub ActionsでANSIエスケープシーケンスを利用した出力を行うと、ブラウザ上で閲覧する際にもよしなに修飾されて表示される。このような太字や着色などの修飾付きの出力に対して正規表現を書く場合には、エスケープシーケンスを考慮したパターンを記述しないと上手くいかないので、注意が必要だ。</p>

<p>RuboCop Problem Matchersでは、対応も面倒そうなので色付きの出力 (<code>rubocop --color</code>) にはとりあえず未対応としている。</p>

<h2>Severity</h2>

<p>Problem Matchersではseverityという情報をキャプチャすることも出来るようになっているが、これは少なくともGitHub ChecksとGitHub Actionsの出力ログのところで黄色く表示されるか赤く表示されるかという違いに影響している。少なくとも <code>"warning"</code> のときに黄色くなり、それ以外の文字列に対しては基本的に <code>"error"</code> 相当で赤くなるということが分かった。</p>

<p>RuboCopの違反には出力で言うと <code>W</code> と <code>C</code> の2パターンがあるので、RuboCop Problem Matchersではそれぞれwarningとerrorに割り当てている。<a href="https://github.com/r7kamura/rubocop-problem-matchers-action/blob/b8ef1656b34a223cf80f04e6b45b5bb6722cef31/.github/matchers/rubocop.json">ソースコード</a>を見ると分かるが、このために2つのMatcherを用意している。それぞれのMatcherに異なる名前を割り当てており、名前を指定して特定のMatcherを無効化する機能も提供されているので、利用者側で警告だけ非表示にするなどの使い方も考えられる。</p>

  </div>
</article>

  </main>
</body>
</html>
