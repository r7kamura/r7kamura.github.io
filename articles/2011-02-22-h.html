<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>httpd.confについて調べたのでまとめたよ</title>
  <link href="https://r7kamura.com/articles/2011-02-22-h" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="最近学科の友人3人とサーバ/セキュリティについての勉強会を週1で行っていて、毎回何か調べてくることになっており、今回は apache の設定について少し調べてきました。">
  <meta property="og:description" content="最近学科の友人3人とサーバ/セキュリティについての勉強会を週1で行っていて、毎回何か調べてくることになっており、今回は apache の設定について少し調べてきました。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="httpd.confについて調べたのでまとめたよ">
  <meta property="og:url" content="https://r7kamura.com/articles/2011-02-22-h">
  
  <meta property="og:image" content="https://r7kamura.com/default_og_image.jpg">
  <meta property="twitter:card" content="summary">
  
</head>
<body>
  <header>
    <nav>
      <p>
        <a href="/">r7kamura.com</a>
      </p>
      <ul>
        <li>
          <a href="/links">リンク集</a>
        </li>
        <li>
          <a href="https://www.google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <header>
    <time datetime="2011-02-22T00:00:00+00:00">2011年02月22日</time>
    <h1>httpd.confについて調べたのでまとめたよ</h1>
  </header>
  <div>
    <p>最近学科の友人3人とサーバ/セキュリティについての勉強会を週1で行っていて、毎回何か調べてくることになっており、今回は apache の設定について少し調べてきました。初心者がまとめたので間違っている部分があるかもしれませんが、勉強の役に立てて頂ければ幸いです。</p>

<ul>
<li>httpd.confはどこにある？</li>
<li>最小限のhttpd.conf</li>
<li>3つのセクション

<ul>
<li>セクション1: GlobalEnvironment</li>
<li>セクション2: MainServerConfiguration</li>
<li>セクション3: VirtualHosts</li>
</ul>
</li>
<li>モジュールの追加</li>
<li>外部設定ファイルの読込み</li>
<li>サーバリソースの監視方法</li>
</ul>

<h4>httpd.confはどこにある？</h4>

<p>OSによって異なりますが、以下の階層に置いてある可能性が高いです。</p>

<p>| CentOS、FedoraなどRed Hat系 | /etc/httpd/conf/ |
| SUSE系、MacOSX | /etc/apache2/ |
| ソースからインストールした場合 | /usr/local/apache2/conf/ |</p>

<h4>最小限のhttpd.conf</h4>

<p>httpd.conf は標準でもコメント含めて1000行くらい記述してあることが多いですが、以下の少ない設定でも動作します。httpd.confの理解を目的とするのであれば、小さな設定から徐々に設定項目を増やしていくことをお勧めします。ちなみにhttpd.confは再起動した時点で反映されます。</p>

<pre><code>Listen 80ServerRoot "/etc/httpd"DocumentRoot "/var/www/html/"User nobody Group nobody\&lt;IfModule prefork.c\&gt;MaxClients 150StartServers 5MinSpareServers 5MaxSpareServers 15\&lt;/IfModule\&gt;\&lt;IfModule worker.c\&gt;StartServers 2MaxClients 150MinSpareThreads 25MaxSpareThreads 75ThreadsPerChild 25MaxRequestsPerChild 0\&lt;/IfModule\&gt;MaxRequestsPerChild 0ErrorLog logs/error\_log\&lt;Directory /\&gt; Options FollowSymLinks AllowOverride None\&lt;/Directory\&gt;
</code></pre>

<h4>3つのセクション</h4>

<p>httpd.confの設定項目(ディレクティブ)は、その影響範囲によって主に下記の3つに分類されます。</p>

<p>| Section1 | GlobalEnvironment | Apache全体に影響を及ぼします |
| Section2 | MainServerConfiguration | メインのサーバに影響を及ぼします。VirtualHost設定時のデフォルト値にもなります |
| Section3 | VirtualHosts | 指定したドメイン/ホストに影響を与えます。MainServerConfigurationを上書きします |</p>

<h5>セクション1: GlobalEnvironment</h5>

<pre><code># SampleServerRoot "/usr/local/apache2"Listen 80KeepAlive On KeepAliveTimeout 15MaxKeepAliveRequests 100Timeout 300
</code></pre>

<p>| ServerRoot | Apacheをインストールした場所のパス。以降のディレクトリ指定で相対パスを利用する場合等に利用 |
| Listen | 特定のIPアドレスやポート番号だけを受け付ける指定。VirtualHostではここの設定のポート範囲内のみ使用できる |
| KeepAlive | クライアントからの接続要求時にHTTPセッションを即座に閉じず一定時間保っておく設定。パフォーマンス向上に繋がる。ブラウザ側の対応に依存する |
| KeepAliveTimeout | HTTPセッションを保っておく秒数。値を大きくすると転送完了後もクライアントとの接続を維持したままになり他のクライアントへの応答が遅れる。1ページ当たりの平均的な転送時間+αが参考値。サーバのリソース消費を嫌うなら2程度の極端な値に設定するなど |
| MaxKeepAliveRequests | KeepAlive有効時に接続要求を受け付ける数の最大許容値。高い値に設定しておくことが推奨されている。大きな値を設定すると一度のリクエスト処理数が増える代わりに他の接続が割り込むタイミングが遅れる。1ページあたりの平均ファイル数+αが参考値 |
| Timeout | クライアントから接続要求を受け取ってタイムアウトするまでの秒数。これを過ぎてもパケットが送信されない場合ブラウザにエラーを返す |</p>

<h5>セクション2: MainServerConfiguration</h5>

<pre><code># SampleUser apache Group apache ServerName example.com ServerAdmin root@example.com DocumentRoot "/var/www/html"\&lt;Directory /\&gt; ... \&lt;/Directory\&gt;DirectoryIndex index.html index.php TypesConfig conf/mime.types DefaultType text/plain ServerTokens Prod ServerSignature Off Alias /icons/ "/usr/local/apache2/icons/"
</code></pre>

<p>| User / Group | サーバーを実行する為のユーザとグループの指定。apache用に特定のユーザとグループを作成しておくことが推奨されている |
| ServerName | サーバ自身が使用するサーバ名とポート番号の指定。BINDで自動取得出来る場合があるが起動時の問題を避けるため指定しておくことが推奨されている |
| ServerAdmin | エラーメッセージ等に表示される管理者メールアドレス |
| DocumentRoot | ドキュメントルートの指定。基本的にここより上位階層にはアクセス出来ないがSymbolicLinkやAliasを使用すれば実現可能。Aliasはmod_aliasで提供されている機能 |
| <directory></directory> ... | 個々のディレクトリに対する設定。サーバールート(/)に対しての設定は必須 |
| DirectoryIndex | スラッシュ「/」で終わるURLを指定した際にデフォルトで表示するファイルを指定。指定したファイルが存在しない場合は、404または403エラーコードを返す |
| TypesConfig | ファイル拡張子とMIMEタイプのマッピングファイルの指定。.htaccessでもAddType application/x-smaf mmfなどで追加できる |
| DefaultType | MIMEタイプファイルに記述が無かった場合の扱いを指定 |
| ServerTokens | エラーメッセージ出力時等のサーバ情報を制限。情報が多い順に Full, OS, Min, Minor, Major, Prod |
| ServerSignature | エラーメッセージ等をクライアントに返す際のフッターラインの表示を指定。On, Off, EMail(mailto:...が付く)が指定可能 |
| Alias | 第1引数へのアクセスを第2引数へ繋ぐ。/icons/のように後ろにスラッシュが入った場合は/iconsというURL自体はエイリアスされないので注意 |</p>

<h5>セクション3: VirtualHosts</h5>

<pre><code># SampleNameVirtualHost \*:80\&lt;VirtualHost \*:80\&gt; ServerName arumakan.org DocumentRoot /var/www/lokka/public \&lt;Directory /var/www/lokka/public\&gt; Allow from all \&lt;/Directory\&gt;\&lt;/VirtualHost\&gt;\&lt;VirtualHost \*:80\&gt; ServerName gakuweb.com DocumentRoot /var/www/eden/public \&lt;Directory /var/www/html\&gt; Allow from all \&lt;/Directory\&gt;\&lt;/VirtualHost\&gt;\&lt;VirtualHost \*:80\&gt; ServerName 19950117.jp DocumentRoot /var/www/shinsaiNow/public \&lt;Directory /var/www/html\&gt; Allow from all \&lt;/Directory\&gt;\&lt;/VirtualHost\&gt;
</code></pre>

<p>上記の例の場合、全てのIPアドレスの80番ポートへのアクセスはNameVirtualHostが全て扱い、ServerNameに設定しているドメイン名別に違うディレクトリへアクセスするようにしています。ここに記載されていないがIPアドレス自体はこのサーバを向いているというドメインにアクセスした場合は、最も上に記述しているServername arumakan.orgの設定が適用されます。</p>

<p>上記の例では名前ベースのVirtualHost(NameVirtualHost)を利用しています。<br>
VirtualHostの設定には以下の2種類の方法があります(混合も可能)。</p>

<p>| 名前ベース | アクセスされる名前(ホスト/ドメイン)によって挙動を変える |
| IPアドレスベース | アクセスされるIPアドレスによって挙動を変える |</p>

<p>前者は1つのサーバに対して複数の名前が与えられているとき、後者は1つのサーバに対して複数のIPアドレスが与えられている時に有効な設定です。個人でサービス開発を行っている場合には前者のケースの方が多いかと思います。例えば私の場合であれば、さくらVPSで借りているCentOSのサーバにIPアドレスを1つ頂いていますが、そのIPアドレスに対して<a href="http://19950117.jp">19950117.jp</a>や<a href="http://gakuweb.com">gakuweb.com</a>という名前をドメイン取得元のDNS設定で与えています。これらは別のサービスなので、名前ベースのVirtualHostの設定を行い、ドメインによってそれぞれアクセスされるディレクトリを変えています。</p>

<p>名前ベースのVirtualHostを期待通りに動作させるには、アクセスがどのような流れで解決されるのかを知っておく必要があります。example.comに対してアクセスがあった時の大まかな流れを以下に示します。</p>

<ol>
<li>
<a href="http://example.com">http://example.com</a> に対してアクセスが行われた</li>
<li>listen *:80 を設定しているのでApacheはこれを処理することを決めた</li>
<li>NameVirtualHost *:80 を設定しているので主サーバー自体はこれを扱わずVirtualHostに委譲</li>
<li>VirtualHost の中でexample.comに一致する条件を設定しているものを探す</li>
<li>VirtualHost *:80 を設定しているものが2つあった</li>
<li>2つの中でServerName example.comのものを選ぶ。 <strong>無ければ1番上に記述しているものを選ぶ</strong>
</li>
<li>ServerName example.com の設定をしているVirtualHostが1つあった</li>
<li>その中のDocumentRootを見に行く</li>
<li>URLでファイル名が指定されていないのでindex.htmlなどを見に行く</li>
</ol>

<h4>モジュールの追加</h4>

<p>Apacheの基本的な機能と設定の説明は以上ですが、Apacheはモジュールを追加することで機能を拡張することが出来ます。Apacheに組み込めるモジュールの種類は大きく分けて以下の2つに分類されます。</p>

<ol>
<li>コンパイル時に組み込まれるモジュール</li>
<li>実行時に組み込まれるモジュール</li>
</ol>

<p>httpdに-lオプションを渡して実行すればコンパイル時に追加されているモジュールを確認できます。またApache2.0以降ではDSO(DynamicSharedObject)という機能で実行時にもモジュールを取り込めます。実行時にモジュールを組み込むにはhttpd.conf等に以下のように設定します。標準でもかなり多くのモジュールが設定されていますが、パフォーマンスに影響を与えるので、理解可能であれば必要最低限のモジュールのみ読み込むように設定した方が良いです。</p>

<pre><code>X / \_ / X \&lt; /usr/sbin/httpd -lCompiled in modules: core.c prefork.c http\_core.c mod\_so.c X / \_ / X \&lt; cat /etc/httpd/conf/httpd.conf -n | grep LoadModule 146# LoadModule foo\_module modules/mod\_foo.so147 LoadModule auth\_basic\_module modules/mod\_auth\_basic.so 148 LoadModule auth\_digest\_module modules/mod\_auth\_digest.so 149 LoadModule authn\_file\_module modules/mod\_authn\_file.so 150 LoadModule authn\_alias\_module modules/mod\_authn\_alias.so 151 LoadModule authn\_anon\_module modules/mod\_authn\_anon.so ...
</code></pre>

<h4>外部設定ファイルの読込み</h4>

<p>Fedora Core / SUSE / Turbo 等のOSではconf.d/*.confという外部ファイルに設定を分け、それらを起動時に読み込む設定をhttpd.confに書くが常套手段となっています。ここのパスはServerRootで指定されたディレクトリからの相対パスなので注意してください。この設定により、ServerRoot/conf.d/ 以下の拡張子.confのファイルが全て設定ファイルとして読み込まれます。例として、<a href="http://example.com/blog">http://example.com/blog</a> へのアクセスに対してアクセスされるディレクトリをwordpressに設定するため、conf.d/wordpress.confにAliasの設定を書くなどの利用方法が挙げられます。</p>

<pre><code>X / \_ / X \&lt; cat /etc/httpd/conf/httpd.conf -n | grep \*.conf 210 Include conf.d/\*.conf X / \_ / X \&lt; tree /etc/httpd /etc/httpd |-- conf | |-- httpd.conf | `-- magic|-- conf.d| |-- README| |-- php.conf| |-- phpmyadmin.conf| |-- proxy\_ajp.conf| |-- welcome.conf\_old| `-- wordpress.conf |-- logs -\&gt; ../../var/log/httpd |-- modules -\&gt; ../../usr/lib64/httpd/modules`-- run -\&gt; ../../var/runX / \_ / X \&lt; cat /etc/httpd/conf.d/wordpress.conf Alias /blog /var/www/wordpress
</code></pre>

<h4>サーバリソースの監視方法</h4>

<p>本題とは少し内容が逸れますが、設定のために必要になったのでサーバリソースの監視方法についても少し調べました。Apacheでは使用するプロセス数を設定出来ますが、これにはApacheのプロセスがサーバのリソースにどれだけ影響を与えるかを見極める必要があります。1プロセスあたりのメモリ使用量はpsコマンドやtopコマンドで調べられます。psはシステムで実行中のプロセスを表示するコマンドです。$ ps aux | grep [a]pache のように使用します。[a]と角括弧で括っているのは出力結果にgrepのプロセス自体を含めないためのハックです。真面目に書きたい人は$ ps aux | grep apache | grep -v grepとして「grepが含まれない行だけ出力する」としても良いですね。しかしgrepではpsコマンド1行目の部分が表示されず残念な感じなので、psコマンドに-u apache(USERを指定するオプション)か-C httpd(COMMANDを指定するオプション)を付けます。</p>

<pre><code># Usageps [-] [acefhjlmnrsuvwxS] [txx] [O[+|-]k1[[+|-]k2...]] [pids]# Sample - COMMANDにhttpdを含むプロセスをユーザ名と開始時刻とツリー付きで表示X / \_ / X \&lt; ps uf -C httpd USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND root 18796 0.0 0.5 2350123020 ? Ss Feb21 0:00 /usr/sbin/httpd apache 18813 0.0 0.4 2351482552 ? S Feb21 0:01 ＼\_ /usr/sbin/httpd apache 18814 0.0 0.5 2351522608 ? S Feb21 0:01 ＼\_ /usr/sbin/httpd apache 18815 0.0 0.4 2351482548 ? S Feb21 0:01 ＼\_ /usr/sbin/httpd apache 18817 0.0 0.4 2351482540 ? S Feb21 0:01 ＼\_ /usr/sbin/httpd apache 18818 0.0 0.5 2351522612 ? S Feb21 0:01 ＼\_ /usr/sbin/httpd apache 18819 0.0 0.4 2351482544 ? S Feb21 0:01 ＼\_ /usr/sbin/httpd apache 18820 0.0 0.5 2351482588 ? S Feb21 0:01 ＼\_ /usr/sbin/httpd apache 18821 0.0 0.5 2351482556 ? S Feb21 0:01 ＼\_ /usr/sbin/httpd apache 17850 0.0 0.5 2351482708 ? S Feb22 0:00 ＼\_ /usr/sbin/httpd apache 20876 0.0 0.5 2351482804 ? S Feb22 0:00 ＼\_ /usr/sbin/httpd apache 19144 0.0 0.5 2351482788 ? S Feb23 0:00 ＼\_ /usr/sbin/httpd# Sample - uid18796のプロセス(rootが動かしているhttpd)の遷移状態をツリー表示X / \_ / X \&lt; pstree 18796 -u -Ahttpd-+-PassengerWatchd-+-PassengerHelper-+-ruby---2\*[{ruby}] | | `-14\*[{PassengerHelper}] | |-PassengerLoggin(nobody)---{PassengerLoggin} | `-3\*[{PassengerWatchd}]`-11\*[httpd(apache)]
</code></pre>

<p>apacheのプロセスは、まずrootで1本起動させてから内部でUser/Groupに指定したユーザで子プロセスを複数生成します。勉強会中に友人に教えてもらったのですが、pstreeコマンドを利用すると実行中のプロセスの親子関係がツリー構造で表示されて分かりやすいです。上記の例では、rootのhttpdプロセスがapacheのhttpdプロセスを11本生成していることが分かります。またPassengerというRubyOnRailsのアプリをapacheで動かしてくれるモジュールを入れているので、その関係のプロセスも生成されています。プロセス数はapacheがよしなに調整してくれますが、これは『最小限のhttpd.conf』で記述したprefork.c内のStartServers 5(起動時)、MinSpareServers 5(最小数)、MaxSpareServers 15(最大数)の設定に基づいて管理されています。今回はこれらの設定値を最適化するためにメモリ使用量を調べた、という顛末でした。<br>
最後に、psコマンドで利用するオプションと表示される要素について説明しておきます。</p>

<p>オプション</p>

<p>| a | 自分以外のユーザーのプロセスも表示する |
| c | task_structに格納されているコマンド名を表示する |
| e | 「実行命令 + 」に環境変数を付加する |
| f | ツリー形式で表示する |
| h | ヘッダーを表示しない |
| j | pgidとsidを表示する |
| l | 標準のPID，TTY，TIME，CMDに加え，F，S，UID，PPID，C，PRI，NI，ADDR，SZ，VSZ，RSS，WCHAN，STATも表示する |
| m | スレッドも表示する |
| n | USERとWCHANを数字で表示する |
| r | 実行中のプロセスだけ表示する |
| s | シグナル形式で表示する |
| u | ユーザー名と開始時刻を表示する |
| v | vm 形式で表示する |
| w | １行追加して表示を拡大する。wを増やすことによって行数をさらに増やせる |
| x | 制御端末のないプロセスの情報も表示する |
| S | 子プロセスのCPU消費時間とページ・フォルトを合計する |
| txx | tty xxのプロセスのみ表示する |
| pids | 表示するプロセスIDを指定する |</p>

<p>表示される要素の意味</p>

<p>| F | プロセスの状態を示すフラグ。16進数で表されている。それぞれ，00:プロセスが終了している，01:システム･プロセス（常にメモリー上に存在する）， 02:親プロセスからトレースされている，04:親プロセスからトレースされ，停止している，08:プロセスがシグナルで起動できない，10:プロセスがメモリー上にあり，イベント終了までロックされている，20:プロセスがスワップできない，ことを意味している。 |
| USER | プロセスの所有ユーザ |
| UID | ユーザーID |
| PID | プロセスID |
| &amp;CPU | CPUの占有率 |
| &amp;MEM | 実メモリでの占有率 |
| SIZE | 仮想分も含めた使用サイズ[kB] |
| VSZ | 仮想メモリの全サイズ |
| RSS | 使用中の物理メモリー量 |
| TTY | 制御端末の種類および番号 |
| STAT/S | プロセスのステータス。Rは実行可能，Sは停止，Dは割り込み不可の停止，Tは停止またはトレース中，Zはゾンビ・プロセス，Wはスワップ・アウトしたプロセス，Nはナイス値が正であることを表す |
| PPID | 親プロセスID |
| PRI | 優先度 |
| NI | ナイス値 |
| WCHAN | プロセスが休眠状態の時のカーネル関数名 |
| START | プロセスの開始時刻 |
| TIME | プロセスの総実行時間 |
| COMMAND/CMD | プロセスのコマンド名 |</p>

<h4>参考</h4>

<ul>
<li><a href="http://www.atmarkit.co.jp/flinux/rensai/apache2_03/apache03a.html">＠IT：httpd.confによるWebサーバの最適化</a></li>
<li><a href="http://linux.kororo.jp/cont/server/httpd_conf.php">httpd.conf の設定</a></li>
<li><a href="http://itpro.nikkeibp.co.jp/article/COLUMN/20060227/230860/">【 ps 】 実行中のプロセスを表示する - Linuxコマンド集</a></li>
<li><a href="http://www.itmedia.co.jp/help/tips/linux/l0158.html">ITmedia エンタープライズ : Linux Tips「「ps aux」コマンドで表示される項目の意味を知りたい」</a></li>
</ul>

  </div>
</article>

  </main>
</body>
</html>
